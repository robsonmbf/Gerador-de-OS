<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerador de OS - Leitor de Documentos SST</title>

  <!-- Biblioteca para Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- Biblioteca para Word DOCX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
  
  <!-- PDF.js para PDF texto -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
</head>
<body>
  <h2>Gerador de OS - Leitor de Documentos SST</h2>

  <p>Selecione um documento (Word, Excel, PDF ou Imagem):</p>
  <input type="file" id="fileInput" />
  
  <h3>Resultado:</h3>
  <pre id="output" style="white-space: pre-wrap; background:#f7f7f7; padding:10px; border:1px solid #ddd;"></pre>

  <script>
    const API_KEY = AIzaSyA68WRCEi304_XKRr-fJ-NILYMHSIpgH9c; // substitua pela sua nova chave da Vision API

    const fileInput = document.getElementById("fileInput");
    const output = document.getElementById("output");

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      output.textContent = "üîç Processando arquivo...";

      const reader = new FileReader();
      const fileType = file.type;

      // ---- Excel (.xlsx, .xls, .csv)
      if (
        file.name.endsWith(".xlsx") ||
        file.name.endsWith(".xls") ||
        file.name.endsWith(".csv")
      ) {
        reader.onload = (evt) => {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          let text = "";
          workbook.SheetNames.forEach((sheetName) => {
            const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
            text += `üìä Planilha: ${sheetName}\n`;
            sheet.forEach((row) => {
              text += row.join(" | ") + "\n";
            });
          });
          output.textContent = text;
        };
        reader.readAsArrayBuffer(file);
      }

      // ---- Word DOCX
      else if (file.name.endsWith(".docx")) {
        reader.onload = async (evt) => {
          try {
            const arrayBuffer = evt.target.result;
            const result = await mammoth.extractRawText({ arrayBuffer });
            output.textContent = result.value || "‚ùå N√£o foi poss√≠vel extrair texto do Word.";
          } catch (err) {
            output.textContent = "‚ö†Ô∏è Erro ao ler Word: " + err.message;
          }
        };
        reader.readAsArrayBuffer(file);
      }

      // ---- PDF
      else if (fileType === "application/pdf") {
        try {
          const pdfData = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
          let text = "";
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            text += content.items.map((s) => s.str).join(" ") + "\n";
          }
          if (text.trim().length > 0) {
            output.textContent = text;
          } else {
            // Se n√£o tem texto, tentar OCR via Google Vision
            reader.onload = async (evt) => {
              const base64File = evt.target.result.split(",")[1];
              const response = await fetch(
                `https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    requests: [
                      {
                        image: { content: base64File },
                        features: [{ type: "DOCUMENT_TEXT_DETECTION" }]
                      }
                    ]
                  })
                }
              );
              const result = await response.json();
              output.textContent =
                result.responses?.[0]?.fullTextAnnotation?.text || "‚ùå Nenhum texto encontrado via OCR.";
            };
            reader.readAsDataURL(file);
          }
        } catch (err) {
          output.textContent = "‚ö†Ô∏è Erro ao ler PDF: " + err.message;
        }
      }

      // ---- Imagens (JPG, PNG, etc.) ‚Üí OCR com Google Vision
      else if (fileType.startsWith("image/")) {
        reader.onload = async (evt) => {
          const base64File = evt.target.result.split(",")[1];
          const response = await fetch(
            `https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                requests: [
                  {
                    image: { content: base64File },
                    features: [{ type: "TEXT_DETECTION" }]
                  }
                ]
              })
            }
          );
          const result = await response.json();
          output.textContent =
            result.responses?.[0]?.fullTextAnnotation?.text || "‚ùå Nenhum texto encontrado via OCR.";
        };
        reader.readAsDataURL(file);
      }

      else {
        output.textContent = "‚ùå Tipo de arquivo n√£o suportado neste prot√≥tipo.";
      }
    });
  </script>
</body>
</html>

