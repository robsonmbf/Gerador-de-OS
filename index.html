<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Ordem de Serviço (OS) com OCR Avançado</title>
    <!-- Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) para ler arquivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- html2pdf.js para gerar PDFs a partir de HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Tesseract.js para OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        /* Definição de variáveis de cor para os temas claro e escuro */
        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --card-bg-color: #ffffff;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-color: #e5e7eb;
            --input-bg-color: #ffffff;
            --input-placeholder-color: #9ca3af;
            --tab-inactive-color: #6b7280;
            --tab-active-color: #2563eb;
            --tab-active-bg: #eff6ff;
        }

        .dark {
            --bg-color: #111827;
            --text-color: #d1d5db;
            --card-bg-color: #1f2937;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --border-color: #374151;
            --input-bg-color: #374151;
            --input-placeholder-color: #6b7280;
            --tab-inactive-color: #9ca3af;
            --tab-active-color: #60a5fa;
            --tab-active-bg: #1e293b;
        }

        body { 
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .card { 
            background-color: var(--card-bg-color); 
            box-shadow: var(--card-shadow);
            transition: background-color 0.3s;
        }
        .btn { transition: all 0.3s ease; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .risk-checkbox-container { 
            height: 200px; /* Altura fixa para melhor alinhamento */
            overflow-y: auto; 
            border: 1px solid var(--border-color); 
            background-color: var(--bg-color);
            border-radius: 0.5rem; 
            padding: 0.75rem; 
        }
        #os-preview { font-family: 'Times New Roman', Times, serif; color: #000; background: #fff; padding: 2rem; border: 1px solid #ccc; line-height: 1.5; }
        #os-preview h2, #os-preview h3 { font-weight: bold; text-align: center; margin-top: 1rem; margin-bottom: 0.5rem; font-size: 12pt; }
        #os-preview p { text-align: justify; margin-bottom: 1rem; font-size: 11pt; }
        #os-preview table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; font-size: 11pt; }
        #os-preview td { border: 1px solid #000; padding: 4px 8px; vertical-align: top; }
        #os-preview .header-table td { font-weight: bold; }
        #os-preview .signature-line { border-top: 1px solid #000; margin-top: 3rem; text-align: center; padding-top: 0.5rem; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 24px; height: 24px; animation: spin 2s linear infinite; }
        .blinking-border { animation: blink 1s 3; }
        .tab-button { color: var(--tab-inactive-color); }
        .tab-button.active { border-color: var(--tab-active-color); color: var(--tab-active-color); background-color: var(--tab-active-bg); }
        input, select, textarea { 
            background-color: var(--input-bg-color); 
            border-color: var(--border-color);
            color: var(--text-color);
        }
        input::placeholder, textarea::placeholder { color: var(--input-placeholder-color); }
        @keyframes blink { 50% { border-color: #ef4444; box-shadow: 0 0 10px #ef4444; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl font-bold text-gray-900 dark:text-white">Gerador Automatizado de Ordem de Serviço</h1>
            <p class="text-lg text-gray-600 dark:text-gray-300 mt-2">Um assistente inteligente para as suas necessidades de SST.</p>
            <button id="theme-toggle" class="absolute top-0 right-0 p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                <!-- Ícone de Sol (Modo Claro) -->
                <svg id="theme-toggle-sun" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <!-- Ícone de Lua (Modo Escuro) -->
                <svg id="theme-toggle-moon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <!-- Área de Notificação -->
        <div id="notification-area" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert">
            <span class="font-medium" id="notification-title"></span> <span id="notification-message"></span>
        </div>

        <div class="card p-6 sm:p-8">
            <!-- Navegação por Abas -->
            <div class="border-b" style="border-color: var(--border-color);">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button id="tab-btn-1" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">1. Dados Iniciais</button>
                    <button id="tab-btn-2" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg hover:border-gray-300">2. Análise de Riscos</button>
                    <button id="tab-btn-3" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg hover:border-gray-300">3. Finalizar e Relatório</button>
                </nav>
            </div>

            <!-- Conteúdo das Abas -->
            <div class="pt-8">
                <!-- Aba 1: Dados Iniciais -->
                <div id="tab-content-1" class="tab-content">
                    <div class="space-y-8">
                        <div>
                            <h3 class="text-xl font-semibold mb-4">1. Carregar Arquivos</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <label for="xlsx-input" class="block mb-2 font-medium">1.1 - Planilha de Funcionários (.xlsx):</label>
                                    <input type="file" id="xlsx-input" accept=".xlsx" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-blue-50 dark:file:bg-blue-900 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 cursor-pointer">
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Colunas: 'Nome do Funcionário', 'Data de Admissão'.</p>
                                </div>
                                <div>
                                    <label for="sst-doc-input" class="block mb-2 font-medium">1.2 - Documento de SST (PGR, etc.):</label>
                                    <input type="file" id="sst-doc-input" accept="image/*,application/pdf" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-blue-50 dark:file:bg-blue-900 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 cursor-pointer">
                                    <div id="ocr-status" class="mt-2 text-sm flex items-center gap-2"></div>
                                </div>
                            </div>
                        </div>

                        <div class="border-t pt-6" style="border-color: var(--border-color);">
                            <h3 class="text-xl font-semibold mb-4">2. Selecionar Funcionário</h3>
                            <label for="employee-select" class="block mb-2 font-medium">Funcionário:</label>
                            <select id="employee-select" disabled class="w-full p-2 border rounded-lg bg-gray-200 dark:bg-gray-700 cursor-not-allowed transition-all duration-300">
                                <option>Aguardando planilha...</option>
                            </select>
                        </div>

                        <div id="validation-section" class="hidden border-t pt-6" style="border-color: var(--border-color);">
                            <h3 class="text-xl font-semibold mb-4">3. Validar Dados Extraídos</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">O sistema extraiu as informações abaixo. Revise, corrija ou complete conforme necessário.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="manual-setor" class="block text-sm font-medium">Setor:</label>
                                    <input type="text" id="manual-setor" class="w-full p-2 border rounded-lg transition-all duration-300">
                                </div>
                                <div>
                                    <label for="manual-funcao" class="block text-sm font-medium">Função:</label>
                                    <input type="text" id="manual-funcao" class="w-full p-2 border rounded-lg transition-all duration-300">
                                </div>
                                <div class="md:col-span-2">
                                    <label for="manual-atividades" class="block text-sm font-medium">Descrição das Atividades:</label>
                                    <textarea id="manual-atividades" rows="3" class="w-full p-2 border rounded-lg" placeholder="Nenhuma descrição de atividades encontrada..."></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="manual-epi" class="block text-sm font-medium">EPIs (Equipamentos de Proteção Individual):</label>
                                    <textarea id="manual-epi" rows="3" class="w-full p-2 border rounded-lg" placeholder="Nenhuma informação de EPI encontrada..."></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="manual-medicoes" class="block text-sm font-medium">Medições Ambientais:</label>
                                    <textarea id="manual-medicoes" rows="3" class="w-full p-2 border rounded-lg" placeholder="Nenhuma medição encontrada..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba 2: Análise de Riscos -->
                <div id="tab-content-2" class="tab-content hidden">
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="risk-cards-container">
                        <!-- Risk Cards will be generated by JS -->
                    </div>
                </div>

                <!-- Aba 3: Finalizar e Relatório -->
                <div id="tab-content-3" class="tab-content hidden">
                    <div class="text-center mb-8">
                         <h3 class="text-xl font-semibold mb-4">Gerar Ordem de Serviço</h3>
                        <button id="generate-pdf-btn" disabled class="btn bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                            Gerar PDF da Ordem de Serviço
                        </button>
                    </div>
                    <div class="border-t pt-8" style="border-color: var(--border-color);">
                        <h3 class="text-xl font-semibold mb-4">Relatório de OS Geradas (nesta sessão)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full border" style="border-color: var(--border-color);">
                                <thead style="background-color: var(--accordion-header-bg);">
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-color);">Nome do Funcionário</th>
                                        <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-color);">Setor</th>
                                        <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-color);">Função</th>
                                    </tr>
                                </thead>
                                <tbody id="report-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de Pré-visualização (oculta) -->
        <div id="os-container" class="hidden"><div id="os-preview"></div></div>
    </div>

    <script>
        // --- BANCO DE DADOS DE RISCOS E DANOS ---
        const riskData = {
            fisico: {
                "Ruído": ["Perda Auditiva Induzida pelo Ruído Ocupacional (PAIRO)."], "Calor": [], "Frio": [],
                "Pressões anormais": ["Embolia gasosa", "Danos pulmonares", "Doença descompressiva"],
                "Radiações ionizantes": ["Dano às células do corpo humano, causando doenças graves, inclusive fatais, como câncer."],
                "Radiações não-ionizantes": ["Depressão imunológica", "fotoenvelhecimento", "lesões oculares como ceratoconjuntivite", "pterígio e catarata", "Doenças graves, inclusive fatais, como câncer."],
                "Umidade": ["Doenças de pele", "Micoses", "Doenças respiratórias"],
                "Vibrações localizadas (mão/braço)": ["Alterações articulares e vasomotoras."],
                "Vibração de corpo inteiro (AREN)": ["Alterações no sistema digestivo", "sistema musculoesquelético", "sistema nervoso", "alterações na visão", "enjoos", "náuseas", "palidez."],
                "Vibração de corpo inteiro (VDVR)": ["Alterações no sistema digestivo", "sistema musculoesquelético", "sistema nervoso", "alterações na visão", "enjoos", "náuseas", "palidez."],
                "Ambiente Artificialmente Frio": ["Estresse", "desconforto", "dormência", "rigidez nas partes com maior intensidade de exposição ao frio", "redução da destreza", "formigamento", "redução da sensibilidade dos dedos e flexibilidade das articulações."],
                "Trabalhos com perfuratrizes e marteletes pneumáticos": ["PAIR", "Problemas articulares e de coluna"],
            },
            quimico: {
                "Arsênio e seus compostos": ["Intoxicação", "Câncer de pele e pulmão"], "Asbestos (ou amianto)": ["Asbestose", "Mesotelioma", "Câncer de pulmão"],
                "Benzeno e seus compostos tóxicos": ["Leucemia", "Anemia", "Danos ao sistema nervoso"], "Berílio e seus compostos tóxicos": ["Beriliose", "Doença pulmonar crônica"],
                "Bromo e seus compostos tóxicos": [], "Cádmio e seus compostos tóxicos": ["Danos renais", "Enfisema pulmonar"], "Carvão mineral e seus derivados": [],
                "Chumbo e seus compostos tóxicos": ["Saturnismo", "Danos neurológicos e renais"], "Cloro e seus compostos tóxicos": [], "Cromo e seus compostos tóxicos": [],
                "Fósforo e seus compostos tóxicos": [], "Hidrocarbonetos e outros compostos de carbono": [], "Iodo": [], "Manganês e seus compostos": [],
                "Mercúrio e seus compostos": ["Hidrargirismo", "Danos neurológicos e renais"], "Níquel e seus compostos tóxicos": ["Dermatite de contato", "Câncer de pulmão e nasal"],
                "Petróleo, xisto betuminoso, gás natural e seus derivados": [], "Sílica livre": ["Silicose", "Doença pulmonar obstrutiva crônica (DPOC)"],
                "Outras substâncias químicas": ["Irritação/lesão ocular, na pele e mucosas", "Dermatites", "Queimadura Química", "Intoxicação", "Náuseas", "Vômitos."]
            },
            biologico: {
                "Trabalhos em estabelecimentos de saúde com contato com pacientes portadores de doenças infectocontagiosas ou com manuseio de materiais contaminados": ["Hepatites", "Tuberculose", "HIV", "COVID-19"],
                "Trabalhos com animais infectados para tratamento ou para o preparo de soro, vacinas e outros produtos": ["Brucelose", "Toxoplasmose", "Raiva"],
                "Trabalhos em laboratórios de autópsia, de anatomia e anátomo-histologia": ["Infecções diversas", "Contaminação por material biológico"],
                "Trabalho de exumação de corpos e manipulação de resíduos de animais deteriorados": ["Infecções", "Contaminação"],
                "Trabalhos em galerias, fossas e tanques de esgoto": ["Leptospirose", "Hepatite A", "Infecções gastrointestinais"], "Esvaziamento de biodigestores": [],
                "Coleta e industrialização do lixo": ["Tétano", "Hepatites", "Infecções de pele"]
            },
            acidente: {
                "Abrasão e/ou escoriação": ["Lesão na pele ou mucosa."], "Agentes cortantes e/ou perfurantes": ["Corte, ferimento, perfuração."],
                "Atropelamento": ["Prensamento ou aprisionamento de partes do corpo", "cortes", "escoriações", "luxações", "fraturas", "amputações."],
                "Batida contra": ["Escoriações", "luxações", "fraturas", "traumatismo craniano."],
                "Contato com animais peçonhentos": ["Reações alérgicas", "choque anafilático", "queimaduras", "intoxicação."],
                "Eletricidade": ["Queimadura de 1º, 2º ou 3º grau", "choque elétrico", "fibrilação ventricular", "parada cardiorrespiratória."],
                "Explosão": ["Queimadura de 1º, 2º ou 3º grau", "projeção de estilhaços", "cortes", "escoriações", "luxações", "fraturas", "amputações."],
                "Incêndio": ["Queimadura de 1º, 2º ou 3º grau", "asfixia", "intoxicação por gases."], "Projeção de partículas": ["Lesão ocular", "corte", "ferimento", "perfuração."],
                "Queda de mesmo nível": ["Escoriações", "luxações", "fraturas", "traumatismo craniano."], "Queda de nível diferente": ["Escoriações", "luxações", "fraturas", "traumatismo craniano", "lesão medular."],
                "Queda de objetos": ["Prensamento ou aprisionamento de partes do corpo", "cortes", "escoriações", "luxações", "fraturas", "amputações."],
                "Soterramento": ["Asfixia", "desconforto respiratório", "nível de consciência alterado", "letargia", "palidez", "pele azulada", "tosse", "transtorno neurológico."],
                "Trabalho em espaços confinados": ["Asfixia", "hiperóxia", "contaminação por poeiras e/ou gases tóxicos", "queimadura", "afogamento."]
            },
            ergonomico: {
                "Levantamento e transporte manual de peso": ["Dores lombares", "Hérnia de disco", "Lesões musculoesqueléticas"],
                "Postura inadequada (sentado, em pé, agachado)": ["Dores na coluna", "Fadiga muscular", "LER/DORT"],
                "Movimentos repetitivos": ["Tendinite", "Tenossinovite", "Síndrome do túnel do carpo", "LER/DORT"],
                "Jornada de trabalho prolongada": ["Estresse", "Fadiga crônica", "Burnout"],
                "Ritmo excessivo de trabalho": ["Estresse", "Ansiedade", "Fadiga mental"],
                "Monotonia das tarefas": ["Desmotivação", "Estresse", "Problemas de saúde mental"],
                "Exigência de força excessiva": ["Distensões musculares", "Rupturas de tendões", "Lesões articulares"]
            }
        };

        // --- LÓGICA DA APLICAÇÃO ---
        let employeeData = [];
        let generatedOSReport = [];
        const defaultText = "Não identificado no momento da avaliação.";

        // DOM Elements
        const notificationArea = document.getElementById('notification-area');
        const notificationTitle = document.getElementById('notification-title');
        const notificationMessage = document.getElementById('notification-message');
        const xlsxInput = document.getElementById('xlsx-input');
        const employeeSelect = document.getElementById('employee-select');
        const sstDocInput = document.getElementById('sst-doc-input');
        const ocrStatus = document.getElementById('ocr-status');
        const validationSection = document.getElementById('validation-section');
        const manualSetor = document.getElementById('manual-setor');
        const manualFuncao = document.getElementById('manual-funcao');
        const manualAtividades = document.getElementById('manual-atividades');
        const manualEpi = document.getElementById('manual-epi');
        const manualMedicoes = document.getElementById('manual-medicoes');
        const generatePdfBtn = document.getElementById('generate-pdf-btn');
        const reportTableBody = document.getElementById('report-table-body');
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('theme-toggle-sun');
        const moonIcon = document.getElementById('theme-toggle-moon');

        // --- FUNÇÕES AUXILIARES ---

        function formatAsTitle(inputText) {
            if (!inputText || typeof inputText !== 'string') return '';
            let txt = inputText.toLowerCase().split(" ");
            let excecoes = ["da", "de", "do", "dos", "das", "em", "para", "com", "no", "na", "nos", "nas"];
            for (let i = 0; i < txt.length; i++) {
                if (!excecoes.includes(txt[i]) || i === 0) {
                    
