<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Ordem de Serviço (OS) com IA</title>
    <!-- Tailwind CSS para estilização (CDN sem SRI por ser um script de compilação JIT) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Bibliotecas de Terceiros com Subresource Integrity (SRI) para maior segurança -->
    <!-- SheetJS (xlsx) para ler arquivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" xintegrity="sha512-r22gChDnGvBylQ9U+B4M7o9ZASiT4eqC_I9LZYK5cvsFRXss33ANsJE90Uss+xMvKkZk6N311mGzB5GY2S7o+Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- html2pdf.js para gerar PDFs a partir de HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Tesseract.js para OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js' xintegrity="sha384-ysoD4/4/DsoK2B3zD/i3p8eJ3yBU5V2b7b2pS227S2h7fSOd22CvjH2kQkAUYh+x" crossorigin="anonymous"></script>
    <!-- PDF.js para ler texto de PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js" xintegrity="sha512-s0jOk9c084BH2o2s9oIMVdCeLSm6nB3U2t2okq5+I2L2kMCl2U9T2v0gA2+VfWkO2/6w2bVvTfHl2zT5gSx/gQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <script>
        // Define o worker para o PDF.js. O SRI é aplicado no script principal acima.
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
    </script>
    <style>
        /* Definição de variáveis de cor para os temas claro e escuro */
        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --header-text-color: #111827;
            --card-bg-color: #ffffff;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-color: #e5e7eb;
            --input-bg-color: #ffffff;
            --input-placeholder-color: #9ca3af;
            --tab-inactive-color: #6b7280;
            --tab-active-color: #2563eb;
            --tab-active-bg: #eff6ff;
            --progress-bg: #e5e7eb;
            --progress-fill: #3b82f6;

            /* Cores dos Riscos - Modo Claro */
            --risk-acidente-color: #2563eb;  /* Azul */
            --risk-ergonomico-color: #ca8a04; /* Amarelo */
            --risk-quimico-color: #dc2626;   /* Vermelho */
            --risk-fisico-color: #16a34a;    /* Verde */
            --risk-biologico-color: #b45309; /* Marrom (Ambar) */
        }

        .dark {
            --bg-color: #111827;
            --text-color: #d1d5db;
            --header-text-color: #ffffff;
            --card-bg-color: #1f2937;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --border-color: #374151;
            --input-bg-color: #374151;
            --input-placeholder-color: #6b7280;
            --tab-inactive-color: #9ca3af;
            --tab-active-color: #60a5fa;
            --tab-active-bg: #1e293b;
            --progress-bg: #374151;
            --progress-fill: #60a5fa;
            
            /* Cores dos Riscos - Modo Escuro (mais claras para contraste) */
            --risk-acidente-color: #60a5fa;   /* Azul Claro */
            --risk-ergonomico-color: #facc15;   /* Amarelo Claro */
            --risk-quimico-color: #f87171;     /* Vermelho Claro */
            --risk-fisico-color: #4ade80;     /* Verde Claro */
            --risk-biologico-color: #f59e0b;   /* Marrom/Ambar Claro */
        }

        body { 
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .header-text { color: var(--header-text-color); }
        .card { 
            background-color: var(--card-bg-color); 
            box-shadow: var(--card-shadow);
            transition: background-color 0.3s;
        }
        .btn { transition: all 0.3s ease; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .risk-checkbox-container { 
            height: 200px;
            overflow-y: auto; 
            border: 1px solid var(--border-color); 
            background-color: var(--bg-color);
            border-radius: 0.5rem; 
            padding: 0.75rem; 
        }
        #os-preview, #live-os-preview { 
            font-family: 'Times New Roman', Times, serif; 
            color: #000; 
            background: #fff; 
            padding: 2rem; 
            border: 1px solid #ccc; 
            line-height: 1.5; 
        }
        #os-preview h2, #os-preview h3, #live-os-preview h2, #live-os-preview h3 { 
            font-weight: bold; text-align: center; margin-top: 1rem; margin-bottom: 0.5rem; font-size: 12pt; 
        }
        #os-preview p, #live-os-preview p { 
            text-align: justify; margin-bottom: 1rem; font-size: 11pt; 
        }
        #os-preview table, #live-os-preview table { 
            width: 100%; border-collapse: collapse; margin-bottom: 1rem; font-size: 11pt; 
        }
        #os-preview td, #live-os-preview td { 
            border: 1px solid #000; padding: 4px 8px; vertical-align: top; 
        }
        #os-preview .header-table td, #live-os-preview .header-table td { 
            font-weight: bold; 
        }
        #os-preview .signature-line, #live-os-preview .signature-line { 
            border-top: 1px solid #000; margin-top: 3rem; text-align: center; padding-top: 0.5rem; 
        }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 24px; height: 24px; animation: spin 2s linear infinite; }
        .blinking-border { animation: blink 1s 3; }
        .tab-button { color: var(--tab-inactive-color); }
        .tab-button.active { border-color: var(--tab-active-color); color: var(--tab-active-color); background-color: var(--tab-active-bg); }
        input, select, textarea { 
            background-color: var(--input-bg-color); 
            border-color: var(--border-color);
            color: var(--text-color);
        }
        input::placeholder, textarea::placeholder { color: var(--input-placeholder-color); }
        
        /* Estilos para o Checklist e Barra de Progresso */
        .checklist-item { transition: all 0.3s ease; }
        .checklist-item.completed { color: #16a34a; }
        .checklist-item.completed .status-icon { background-color: #16a34a; color: white; }
        .status-icon {
            width: 24px; height: 24px; border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            font-weight: bold; border: 2px solid;
        }
        .progress-bar-container {
            width: 100%;
            background-color: var(--progress-bg);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .progress-bar {
            height: 1.25rem;
            background-color: var(--progress-fill);
            width: 0%;
            transition: width 0.4s ease;
            text-align: center;
            line-height: 1.25rem;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .dynamic-input-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .dynamic-input-row.medicao {
            grid-template-columns: 1fr 1fr 1fr auto;
        }
        .dynamic-input-row.epi {
            grid-template-columns: 1fr 1fr auto;
        }
        .remove-btn {
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Estilos do Chat IA */
        #chat-toggle-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }
        #chat-modal {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 90%;
            max-width: 400px;
            z-index: 1000;
            transition: all 0.3s ease-in-out;
        }
        #chat-messages {
            height: 300px;
            overflow-y: auto;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
        }
        .chat-bubble.user {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        .chat-bubble.ai {
            background-color: var(--bg-color);
            color: var(--text-color);
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }

        @keyframes blink { 50% { border-color: #ef4444; box-shadow: 0 0 10px #ef4444; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl font-bold header-text">Gerador de Ordem de Serviço com IA</h1>
            <p class="text-lg mt-2 header-text">Um assistente inteligente para as suas necessidades de SST.</p>
            <button id="theme-toggle" class="absolute top-0 right-0 p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                <!-- Ícone de Sol (Modo Claro) -->
                <svg id="theme-toggle-sun" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <!-- Ícone de Lua (Modo Escuro) -->
                <svg id="theme-toggle-moon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <!-- Área de Notificação -->
        <div id="notification-area" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert">
            <span class="font-medium" id="notification-title"></span> <span id="notification-message"></span>
        </div>

        <div class="card p-6 sm:p-8">
            <!-- Navegação por Abas -->
            <div class="border-b" style="border-color: var(--border-color);">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button id="tab-btn-1" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">1. Dados Iniciais</button>
                    <button id="tab-btn-2" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg hover:border-gray-300">2. Análise de Riscos</button>
                    <button id="tab-btn-4" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg hover:border-gray-300">3. Resumo de Riscos</button>
                    <button id="tab-btn-3" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg hover:border-gray-300">4. Finalizar e Relatório</button>
                </nav>
            </div>

            <!-- Conteúdo das Abas -->
            <div class="pt-8">
                <!-- Aba 1: Dados Iniciais -->
                <div id="tab-content-1" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <!-- Coluna do Checklist -->
                        <div class="md:col-span-1 border-r pr-8" style="border-color: var(--border-color);">
                            <h3 class="text-xl font-semibold mb-4">Checklist de Etapas</h3>
                            <ul class="space-y-4">
                                <li id="checklist-xlsx" class="checklist-item flex items-center gap-3">
                                    <span class="status-icon">1</span>
                                    <span>Carregar planilha de funcionários</span>
                                </li>
                                <li id="checklist-doc" class="checklist-item flex items-center gap-3">
                                    <span class="status-icon">2</span>
                                    <span>Carregar e analisar documento</span>
                                </li>
                                <li id="checklist-funcao" class="checklist-item flex items-center gap-3">
                                    <span class="status-icon">3</span>
                                    <span>Validar/Selecionar Função</span>
                                </li>
                            </ul>
                        </div>

                        <!-- Coluna de Conteúdo Principal -->
                        <div class="md:col-span-2 space-y-8">
                            <div>
                                <h3 class="text-xl font-semibold mb-4">1. Carregar Arquivos e Informações</h3>
                                <div class="grid grid-cols-1 gap-8">
                                    <div>
                                        <label for="xlsx-input" class="block mb-2 font-medium">1.1 - Planilha de Funcionários (.xlsx):</label>
                                        <input type="file" id="xlsx-input" accept=".xlsx" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-blue-50 dark:file:bg-blue-900 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 cursor-pointer">
                                        <div class="mt-2">
                                            <a href="#" id="download-template-btn" class="text-sm text-blue-600 dark:text-blue-400 hover:underline">Baixar modelo de planilha (.xlsx)</a>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="logo-input" class="block mb-2 font-medium">1.2 - Logotipo da Empresa (Opcional):</label>
                                        <input type="file" id="logo-input" accept="image/*" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-blue-50 dark:file:bg-blue-900 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 cursor-pointer">
                                    </div>
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="company-name" class="block mb-2 font-medium">1.3 - Nome da Empresa:</label>
                                            <input type="text" id="company-name" class="w-full p-2 border rounded-lg">
                                        </div>
                                        <div>
                                            <label for="company-unit" class="block mb-2 font-medium">1.4 - Unidade:</label>
                                            <input type="text" id="company-unit" class="w-full p-2 border rounded-lg">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="border-t pt-6" style="border-color: var(--border-color);">
                                <h3 class="text-xl font-semibold mb-4">2. Carregar Documento de SST</h3>
                                <label for="sst-doc-input" class="block mb-2 font-medium">Documento (PGR, LTCAT, etc.):</label>
                                <input type="file" id="sst-doc-input" accept="image/*,application/pdf" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-blue-50 dark:file:bg-blue-900 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 cursor-pointer" disabled>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Carregue a planilha para habilitar.</p>
                                
                                <!-- Opções de Análise -->
                                <div id="analysis-options" class="hidden mt-4 p-4 border rounded-lg" style="border-color: var(--border-color);">
                                    <p class="font-medium mb-2">Escolha o método de análise:</p>
                                    <div class="flex flex-col sm:flex-row gap-4">
                                        <div class="flex-1 space-y-2">
                                            <div class="flex items-center">
                                                <input id="direct-ai-radio" type="radio" value="direct-ai" name="analysis-method" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                                <label for="direct-ai-radio" class="ml-2 text-sm font-medium">Análise Direta via IA <span class="text-xs text-gray-500">(PDFs de texto)</span></label>
                                            </div>
                                            <div class="flex items-center">
                                                <input id="ocr-radio" type="radio" value="ocr" name="analysis-method" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                                <label for="ocr-radio" class="ml-2 text-sm font-medium">Análise via OCR <span class="text-xs text-gray-500">(Imagens, PDFs escaneados)</span></label>
                                            </div>
                                        </div>
                                        <button id="start-analysis-btn" class="btn bg-blue-600 text-white font-bold py-2 px-4 rounded-lg self-center sm:self-end">Analisar</button>
                                    </div>
                                </div>

                                <div id="ai-status" class="mt-2 text-sm flex items-center gap-2"></div>
                                <div id="progress-container" class="hidden mt-2">
                                    <div class="progress-bar-container">
                                        <div id="progress-bar" class="progress-bar">0%</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="border-t pt-6" style="border-color: var(--border-color);">
                                <h3 class="text-xl font-semibold mb-4">3. Validar / Selecionar Setor e Função</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">A IA tentará preencher estes campos. Se necessário, ajuste a seleção para carregar os dados corretos.</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="setor-select" class="block mb-2 font-medium">Setor:</label>
                                        <select id="setor-select" disabled class="w-full p-2 border rounded-lg bg-gray-200 dark:bg-gray-700 cursor-not-allowed transition-all duration-300">
                                            <option>Aguardando planilha...</option>
                                        </select>
                                    </div>
                                    <div>
                                        <div class="flex justify-between items-center mb-2">
                                            <label for="funcao-select" class="block font-medium">Função:</label>
                                            <span id="employee-count" class="text-xs font-semibold text-gray-500 dark:text-gray-400"></span>
                                        </div>
                                        <select id="funcao-select" disabled class="w-full p-2 border rounded-lg bg-gray-200 dark:bg-gray-700 cursor-not-allowed transition-all duration-300">
                                            <option>Selecione um setor...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div id="validation-section" class="hidden border-t pt-6" style="border-color: var(--border-color);">
                                <h3 class="text-xl font-semibold mb-4">4. Validar Dados Extraídos</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">A IA extraiu as informações abaixo. Revise, corrija ou complete conforme necessário.</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="md:col-span-2">
                                        <label for="manual-atividades" class="block text-sm font-medium">Descrição das Atividades:</label>
                                        <textarea id="manual-atividades" rows="3" class="w-full p-2 border rounded-lg" placeholder="Nenhuma descrição de atividades encontrada..."></textarea>
                                    </div>
                                    
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium mb-2">EPIs (Equipamentos de Proteção Individual):</label>
                                        <div id="epi-list"></div>
                                        <button id="add-epi-btn" class="btn text-sm bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-lg mt-2">Adicionar EPI</button>
                                    </div>

                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium mb-2">Medições Ambientais:</label>
                                        <div id="medicao-list"></div>
                                        <button id="add-medicao-btn" class="btn text-sm bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-lg mt-2">Adicionar Medição</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba 2: Análise de Riscos -->
                <div id="tab-content-2" class="tab-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="risk-cards-container">
                           <!-- Risk Cards will be generated by JS -->
                       </div>
                </div>

                <!-- Aba 4: Resumo de Riscos -->
                <div id="tab-content-4" class="tab-content hidden">
                    <h3 class="text-xl font-semibold mb-4">Resumo de Riscos por Função (Extraído do Documento)</h3>
                    <div id="risk-summary-container" class="space-y-4">
                        <p class="text-gray-500">O resumo dos riscos identificados pela IA aparecerá aqui após a análise do documento.</p>
                    </div>
                </div>


                <!-- Aba 3: Finalizar e Relatório -->
                <div id="tab-content-3" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <div class="text-center mb-8 space-y-4">
                               <h3 class="text-xl font-semibold mb-4">Finalizar</h3>
                               <div class="flex justify-center gap-4">
                                    <button id="generate-pdf-btn" disabled class="btn bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                        Gerar OS para a Função
                                    </button>
                               </div>
                            </div>
                            <div class="border-t pt-8" style="border-color: var(--border-color);">
                                <h3 class="text-xl font-semibold mb-4">Relatório de OS Geradas (nesta sessão)</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full border" style="border-color: var(--border-color);">
                                        <thead style="background-color: var(--accordion-header-bg);">
                                            <tr>
                                                <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-color);">Nome do Funcionário</th>
                                                <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-color);">Setor</th>
                                                <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-color);">Função</th>
                                            </tr>
                                        </thead>
                                        <tbody id="report-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div>
                             <h3 class="text-xl font-semibold mb-4 text-center">Pré-visualização da OS</h3>
                             <div id="live-os-preview-container" class="max-h-[80vh] overflow-y-auto">
                                 <div id="live-os-preview">
                                     <p class="text-center text-gray-500">A pré-visualização aparecerá aqui assim que uma função for selecionada.</p>
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de Pré-visualização para PDF (oculta) -->
        <div id="os-container" class="hidden"><div id="os-preview"></div></div>
    </div>
    
    <!-- Botão Flutuante do Chat -->
    <button id="chat-toggle-btn" class="btn bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
    </button>

    <!-- Modal do Chat -->
    <div id="chat-modal" class="hidden card shadow-2xl">
        <div class="p-4 border-b flex justify-between items-center" style="border-color: var(--border-color);">
            <h3 class="text-lg font-semibold">Assistente IA</h3>
            <button id="chat-close-btn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">&times;</button>
        </div>
        <div id="chat-messages" class="p-4 flex flex-col">
            <!-- Mensagens do chat aparecerão aqui -->
        </div>
        <div class="p-4 border-t" style="border-color: var(--border-color);">
            <div class="flex gap-2">
                <input type="text" id="chat-input" class="w-full p-2 border rounded-lg" placeholder="Digite sua mensagem...">
                <button id="chat-send-btn" class="btn bg-blue-600 text-white rounded-lg px-4">Enviar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- BANCO DE DADOS DE RISCOS E DANOS ---
            const riskData = {
                fisico: {
                    "Ruído": ["Perda Auditiva Induzida pelo Ruído Ocupacional (PAIRO)."], "Calor": [], "Frio": [],
                    "Pressões anormais": ["Embolia gasosa", "Danos pulmonares", "Doença descompressiva"],
                    "Radiações ionizantes": ["Dano às células do corpo humano, causando doenças graves, inclusive fatais, como câncer."],
                    "Radiações não-ionizantes": ["Depressão imunológica", "fotoenvelhecimento", "lesões oculares como ceratoconjuntivite", "pterígio e catarata", "Doenças graves, inclusive fatais, como câncer."],
                    "Umidade": ["Doenças de pele", "Micoses", "Doenças respiratórias"],
                    "Vibrações localizadas (mão/braço)": ["Alterações articulares e vasomotoras."],
                    "Vibração de corpo inteiro (AREN)": ["Alterações no sistema digestivo", "sistema musculoesquelético", "sistema nervoso", "alterações na visão", "enjoos", "náuseas", "palidez."],
                    "Vibração de corpo inteiro (VDVR)": ["Alterações no sistema digestivo", "sistema musculoesquelético", "sistema nervoso", "alterações na visão", "enjoos", "náuseas", "palidez."],
                    "Ambiente Artificialmente Frio": ["Estresse", "desconforto", "dormência", "rigidez nas partes com maior intensidade de exposição ao frio", "redução da destreza", "formigamento", "redução da sensibilidade dos dedos e flexibilidade das articulações."],
                    "Trabalhos com perfuratrizes e marteletes pneumáticos": ["PAIR", "Problemas articulares e de coluna"],
                },
                quimico: {
                    "Arsênio e seus compostos": ["Intoxicação", "Câncer de pele e pulmão"], "Asbestos (ou amianto)": ["Asbestose", "Mesotelioma", "Câncer de pulmão"],
                    "Benzeno e seus compostos tóxicos": ["Leucemia", "Anemia", "Danos ao sistema nervoso"], "Berílio e seus compostos tóxicos": ["Beriliose", "Doença pulmonar crônica"],
                    "Bromo e seus compostos tóxicos": [], "Cádmio e seus compostos tóxicos": ["Danos renais", "Enfisema pulmonar"], "Carvão mineral e seus derivados": [],
                    "Chumbo e seus compostos tóxicos": ["Saturnismo", "Danos neurológicos e renais"], "Cloro e seus compostos tóxicos": [], "Cromo e seus compostos tóxicos": [],
                    "Fósforo e seus compostos tóxicos": [], "Hidrocarbonetos e outros compostos de carbono": [], "Iodo": [], "Manganês e seus compostos": [],
                    "Mercúrio e seus compostos": ["Hidrargirismo", "Danos neurológicos e renais"], "Níquel e seus compostos tóxicos": ["Dermatite de contato", "Câncer de pulmão e nasal"],
                    "Petróleo, xisto betuminoso, gás natural e seus derivados": [], "Sílica livre": ["Silicose", "Doença pulmonar obstrutiva crônica (DPOC)"],
                    "Outras substâncias químicas": ["Irritação/lesão ocular, na pele e mucosas", "Dermatites", "Queimadura Química", "Intoxicação", "Náuseas", "Vômitos."]
                },
                biologico: {
                    "Trabalhos em estabelecimentos de saúde com contato com pacientes portadores de doenças infectocontagiosas ou com manuseio de materiais contaminados": ["Hepatites", "Tuberculose", "HIV", "COVID-19"],
                    "Trabalhos com animais infectados para tratamento ou para o preparo de soro, vacinas e outros produtos": ["Brucelose", "Toxoplasmose", "Raiva"],
                    "Trabalhos em laboratórios de autópsia, de anatomia e anátomo-histologia": ["Infecções diversas", "Contaminação por material biológico"],
                    "Trabalho de exumação de corpos e manipulação de resíduos de animais deteriorados": ["Infecções", "Contaminação"],
                    "Trabalhos em galerias, fossas e tanques de esgoto": ["Leptospirose", "Hepatite A", "Infecções gastrointestinais"], "Esvaziamento de biodigestores": [],
                    "Coleta e industrialização do lixo": ["Tétano", "Hepatites", "Infecções de pele"]
                },
                acidente: {
                    "Abrasão e/ou escoriação": ["Lesão na pele ou mucosa."], "Agentes cortantes e/ou perfurantes": ["Corte, ferimento, perfuração."],
                    "Atropelamento": ["Prensamento ou aprisionamento de partes do corpo", "cortes", "escoriações", "luxações", "fraturas", "amputações."],
                    "Batida contra": ["Escoriações", "luxações", "fraturas", "traumatismo craniano."],
                    "Contato com animais peçonhentos": ["Reações alérgicas", "choque anafilático", "queimaduras", "intoxicação."],
                    "Eletricidade": ["Queimadura de 1º, 2º ou 3º grau", "choque elétrico", "fibrilação ventricular", "parada cardiorrespiratória."],
                    "Explosão": ["Queimadura de 1º, 2º ou 3º grau", "projeção de estilhaços", "cortes", "escoriações", "luxações", "fraturas", "amputações."],
                    "Incêndio": ["Queimadura de 1º, 2º ou 3º grau", "asfixia", "intoxicação por gases."], "Projeção de partículas": ["Lesão ocular", "corte", "ferimento", "perfuração."],
                    "Queda de mesmo nível": ["Escoriações", "luxações", "fraturas", "traumatismo craniano."], "Queda de nível diferente": ["Escoriações", "luxações", "fraturas", "traumatismo craniano", "lesão medular."],
                    "Queda de objetos": ["Prensamento ou aprisionamento de partes do corpo", "cortes", "escoriações", "luxações", "fraturas", "amputações."],
                    "Soterramento": ["Asfixia", "desconforto respiratório", "nível de consciência alterado", "letargia", "palidez", "pele azulada", "tosse", "transtorno neurológico."],
                    "Trabalho em espaços confinados": ["Asfixia", "hiperóxia", "contaminação por poeiras e/ou gases tóxicos", "queimadura", "afogamento."]
                },
                ergonomico: {
                    "Levantamento e transporte manual de peso": ["Dores lombares", "Hérnia de disco", "Lesões musculoesqueléticas"],
                    "Postura inadequada (sentado, em pé, agachado)": ["Dores na coluna", "Fadiga muscular", "LER/DORT"],
                    "Movimentos repetitivos": ["Tendinite", "Tenossinovite", "Síndrome do túnel do carpo", "LER/DORT"],
                    "Jornada de trabalho prolongada": ["Estresse", "Fadiga crônica", "Burnout"],
                    "Ritmo excessivo de trabalho": ["Estresse", "Ansiedade", "Fadiga mental"],
                    "Monotonia das tarefas": ["Desmotivação", "Estresse", "Problemas de saúde mental"],
                    "Exigência de força excessiva": ["Distensões musculares", "Rupturas de tendões", "Lesões articulares"]
                }
            };

            // --- VARIÁVEIS GLOBAIS DE ESTADO ---
            let employeeData = [];
            let structuredRoles = {};
            let documentAnalysisResult = null;
            let generatedOSReport = [];
            let logoDataUrl = null;
            const defaultText = "Não identificado no momento da avaliação.";
            const checklistStatus = {
                xlsx: false,
                doc: false,
                funcao: false
            };

            // --- SELEÇÃO DE ELEMENTOS DO DOM ---
            const notificationArea = document.getElementById('notification-area');
            const notificationTitle = document.getElementById('notification-title');
            const notificationMessage = document.getElementById('notification-message');
            const xlsxInput = document.getElementById('xlsx-input');
            const setorSelect = document.getElementById('setor-select');
            const funcaoSelect = document.getElementById('funcao-select');
            const sstDocInput = document.getElementById('sst-doc-input');
            const logoInput = document.getElementById('logo-input');
            const companyNameInput = document.getElementById('company-name');
            const companyUnitInput = document.getElementById('company-unit');
            const aiStatus = document.getElementById('ai-status');
            const validationSection = document.getElementById('validation-section');
            const manualAtividades = document.getElementById('manual-atividades');
            const epiList = document.getElementById('epi-list');
            const addEpiBtn = document.getElementById('add-epi-btn');
            const medicaoList = document.getElementById('medicao-list');
            const addMedicaoBtn = document.getElementById('add-medicao-btn');
            const generatePdfBtn = document.getElementById('generate-pdf-btn');
            const reportTableBody = document.getElementById('report-table-body');
            const themeToggle = document.getElementById('theme-toggle');
            const sunIcon = document.getElementById('theme-toggle-sun');
            const moonIcon = document.getElementById('theme-toggle-moon');
            const liveOsPreview = document.getElementById('live-os-preview');
            const downloadTemplateBtn = document.getElementById('download-template-btn');
            const riskSummaryContainer = document.getElementById('risk-summary-container');
            const employeeCountSpan = document.getElementById('employee-count');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const analysisOptionsDiv = document.getElementById('analysis-options');
            const startAnalysisBtn = document.getElementById('start-analysis-btn');
            const chatToggleBtn = document.getElementById('chat-toggle-btn');
            const chatModal = document.getElementById('chat-modal');
            const chatCloseBtn = document.getElementById('chat-close-btn');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');

            // --- FUNÇÕES AUXILIARES ---
            function formatAsTitle(inputText) {
                if (!inputText || typeof inputText !== 'string') return '';
                let txt = inputText.toLowerCase().split(" ");
                let excecoes = ["da", "de", "do", "dos", "das", "em", "para", "com", "no", "na", "nos", "nas"];
                for (let i = 0; i < txt.length; i++) {
                    if (!excecoes.includes(txt[i]) || i === 0) {
                        txt[i] = txt[i].charAt(0).toUpperCase() + txt[i].slice(1);
                    }
                }
                return txt.join(" ");
            }

            function showNotification(type, title, message) {
                notificationArea.className = 'p-4 mb-4 text-sm rounded-lg';
                let typeClasses = type === 'error' ? 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300' : (type === 'warning' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300' : 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300');
                notificationArea.classList.add(...typeClasses.split(' '));
                notificationTitle.textContent = title;
                notificationMessage.textContent = message;
            }

            function hideNotification() { notificationArea.classList.add('hidden'); }
            
            // --- LÓGICA DO CHECKLIST ---
            function updateChecklist(item, isComplete) {
                checklistStatus[item] = isComplete;
                const element = document.getElementById(`checklist-${item}`);
                const icon = element.querySelector('.status-icon');
                if (isComplete) {
                    element.classList.add('completed');
                    icon.innerHTML = '&#10003;'; // Checkmark
                } else {
                    element.classList.remove('completed');
                    const number = item === 'xlsx' ? '1' : (item === 'doc' ? '2' : '3');
                    icon.innerHTML = number;
                }
                checkFormReadiness();
            }

            // --- LÓGICA DE CRIAÇÃO DA UI ---
            function createRiskCards() {
                const container = document.getElementById('risk-cards-container');
                container.innerHTML = '';
                const riskCategories = {
                    fisico: { title: 'Risco Físico', colorVar: '--risk-fisico-color' },
                    quimico: { title: 'Risco Químico', colorVar: '--risk-quimico-color' },
                    biologico: { title: 'Risco Biológico', colorVar: '--risk-biologico-color' },
                    acidente: { title: 'Risco de Acidente', colorVar: '--risk-acidente-color' },
                    ergonomico: { title: 'Risco Ergonômico', colorVar: '--risk-ergonomico-color' }
                };

                const displayOrder = ['acidente', 'ergonomico', 'quimico', 'fisico', 'biologico'];

                for (const key of displayOrder) {
                    const category = riskCategories[key];
                    const card = document.createElement('div');
                    card.className = 'border-2 rounded-lg p-4 space-y-3 transition-all';
                    card.style.borderColor = `var(${category.colorVar})`;
                    
                    card.innerHTML = `
                        <h4 class="text-lg font-semibold" style="color: var(${category.colorVar});">${category.title}</h4>
                        <div>
                            <label class="block text-sm font-medium mb-1">Perigos / Fatores de Risco:</label>
                            <div id="risk-${key}-checkboxes" class="risk-checkbox-container"></div>
                            <textarea id="risk-${key}-outro" rows="1" class="w-full p-2 border rounded-lg mt-2" placeholder="Outro..."></textarea>
                        </div>
                        <div>
                            <label for="damage-${key}" class="block text-sm font-medium mb-1">Possíveis Danos à Saúde:</label>
                            <textarea id="damage-${key}" rows="3" class="w-full p-2 border rounded-lg" placeholder="Danos serão preenchidos automaticamente..."></textarea>
                        </div>
                    `;
                    container.appendChild(card);
                    container.querySelectorAll('input, textarea').forEach(el => {
                        el.addEventListener('input', () => {
                            updateLivePreview();
                        });
                    });
                }
                populateRiskCheckboxes();
            }

            function populateRiskCheckboxes() {
                for (const category in riskData) {
                    const container = document.getElementById(`risk-${category}-checkboxes`);
                    if (container) {
                        const sortedRisks = Object.keys(riskData[category]).sort();
                        for (const risk of sortedRisks) {
                            const label = document.createElement('label');
                            label.className = 'flex items-center space-x-2 cursor-pointer p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded';
                            const input = document.createElement('input');
                            input.type = 'checkbox'; input.value = risk; input.dataset.category = category;
                            input.className = 'rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-200 dark:bg-gray-700 dark:border-gray-600';
                            const span = document.createElement('span'); span.textContent = risk;
                            label.appendChild(input); label.appendChild(span); container.appendChild(label);
                            input.addEventListener('change', () => {
                                handleRiskSelectionChange();
                                updateLivePreview();
                            });
                        }
                    }
                }
            }
            
            // --- LÓGICA DE EVENTOS E MANIPULAÇÃO DE DADOS ---
            function handleRiskSelectionChange() {
                const categories = ['fisico', 'quimico', 'biologico', 'acidente', 'ergonomico'];
                categories.forEach(category => {
                    const damageTextarea = document.getElementById(`damage-${category}`);
                    const allDamages = new Set();
                    document.querySelectorAll(`#risk-${category}-checkboxes input:checked`).forEach(checkbox => {
                        const risk = checkbox.value;
                        const damages = riskData[category][risk] || [];
                        damages.forEach(damage => allDamages.add(damage));
                    });
                    damageTextarea.value = Array.from(allDamages).join(', ');
                });
            }

            function processAndPopulateSelectors() {
                structuredRoles = {};
                employeeData.forEach(employee => {
                    const setor = findValueInObject(employee, ['Setor']);
                    const funcao = findValueInObject(employee, ['Função', 'Cargo']);
                    if (setor && funcao) {
                        if (!structuredRoles[setor]) {
                            structuredRoles[setor] = new Set();
                        }
                        structuredRoles[setor].add(funcao);
                    }
                });

                setorSelect.innerHTML = '<option value="">-- Selecione um setor --</option>';
                Object.keys(structuredRoles).sort().forEach(setor => {
                    const option = document.createElement('option');
                    option.value = setor;
                    option.textContent = formatAsTitle(setor);
                    setorSelect.appendChild(option);
                });
                setorSelect.disabled = false;
                setorSelect.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'cursor-not-allowed');
                funcaoSelect.innerHTML = '<option value="">Selecione um setor...</option>';
                funcaoSelect.disabled = true;
                sstDocInput.disabled = false;
                sstDocInput.parentElement.querySelector('p').classList.add('hidden');
            }

            function populateFuncaoSelect(selectedSetor) {
                funcaoSelect.innerHTML = '<option value="">-- Selecione uma função --</option>';
                if (selectedSetor && structuredRoles[selectedSetor]) {
                    Array.from(structuredRoles[selectedSetor]).sort().forEach(funcao => {
                        const option = document.createElement('option');
                        option.value = funcao;
                        option.textContent = formatAsTitle(funcao);
                        funcaoSelect.appendChild(option);
                    });
                    funcaoSelect.disabled = false;
                    funcaoSelect.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'cursor-not-allowed');
                } else {
                    funcaoSelect.disabled = true;
                }
            }

            function updateDetailsFromSources() {
                const selectedSetor = setorSelect.value;
                const selectedFuncao = funcaoSelect.value;
                if (!selectedSetor || !selectedFuncao) return;

                validationSection.classList.remove('hidden');
                
                // Limpa campos antes de popular
                manualAtividades.value = '';
                epiList.innerHTML = '';
                medicaoList.innerHTML = '';

                let dataFrom = 'planilha';
                let roleData = null;

                // 1. Tenta pegar dados da análise da IA
                if (documentAnalysisResult && documentAnalysisResult.cargos) {
                    roleData = documentAnalysisResult.cargos.find(cargo => cargo.funcao.trim().toLowerCase() === selectedFuncao.trim().toLowerCase());
                    if (roleData) dataFrom = 'IA';
                }

                // 2. Se não achou na IA, pega da planilha
                if (!roleData) {
                    const representativeEmployee = employeeData.find(emp => {
                        const empSetor = findValueInObject(emp, ['Setor']);
                        const empFuncao = findValueInObject(emp, ['Função', 'Cargo']);
                        return empSetor && empFuncao && empSetor.trim().toLowerCase() === selectedSetor.trim().toLowerCase() && empFuncao.trim().toLowerCase() === selectedFuncao.trim().toLowerCase();
                    });
                    if (representativeEmployee) {
                        roleData = {
                            atividades: findValueInObject(representativeEmployee, ['Atividades', 'Descrição da Função', 'Descrição das Atividades', 'Tarefas']) || '',
                            epis: [],
                            medicoes: []
                        };
                        const episFromSheet = findValueInObject(representativeEmployee, ['EPIs (Separados por \';\')', 'EPI']);
                        if (episFromSheet && typeof episFromSheet === 'string') {
                            const epiItems = episFromSheet.split(';').filter(item => item.trim() !== '');
                            epiItems.forEach(item => {
                                const caMatch = item.match(/C\.A\.\s*-\s*(\d+)/i);
                                const ca = caMatch ? caMatch[1] : '';
                                const name = item.replace(/-\s*C\.A\.\s*-\s*\d+/i, '').trim();
                                roleData.epis.push({ nome: name, ca: ca });
                            });
                        }
                    }
                }

                // 3. Popula os campos com os dados encontrados
                if (roleData) {
                    manualAtividades.value = roleData.atividades || '';
                    if (roleData.epis && Array.isArray(roleData.epis)) {
                        roleData.epis.forEach(epi => addEpiRow(epi.nome, epi.ca));
                    }
                    if (roleData.medicoes && Array.isArray(roleData.medicoes)) {
                        roleData.medicoes.forEach(med => addMedicaoRow(med.agente, med.valor, med.unidade));
                    }
                }
                
                // Atualiza o contador de funcionários
                const matchingEmployees = employeeData.filter(emp => {
                    const empSetor = findValueInObject(emp, ['Setor']);
                    const empFuncao = findValueInObject(emp, ['Função', 'Cargo']);
                    return empSetor && empFuncao && empSetor.trim().toLowerCase() === selectedSetor.trim().toLowerCase() && empFuncao.trim().toLowerCase() === selectedFuncao.trim().toLowerCase();
                });
                employeeCountSpan.textContent = `(${matchingEmployees.length} funcionário(s))`;

                updateRiskSummary();
                checkFormReadiness();
            }

            function checkFormReadiness() {
                const allChecked = Object.values(checklistStatus).every(status => status);
                generatePdfBtn.disabled = !allChecked;
            }
            
            // --- LÓGICA DOS CAMPOS DINÂMICOS ---
            function addEpiRow(name = '', ca = '') {
                const div = document.createElement('div');
                div.className = 'dynamic-input-row epi';
                div.innerHTML = `
                    <input type="text" value="${name}" placeholder="Nome do EPI" class="w-full p-2 border rounded-lg">
                    <input type="text" value="${ca}" placeholder="C.A. (opcional)" class="w-full p-2 border rounded-lg">
                    <button class="remove-btn" type="button">&times;</button>
                `;
                div.querySelector('.remove-btn').addEventListener('click', () => {
                    div.remove();
                    updateLivePreview();
                });
                div.querySelectorAll('input').forEach(input => input.addEventListener('input', updateLivePreview));
                epiList.appendChild(div);
            }

            function addMedicaoRow(agent = '', value = '', unit = '') {
                const div = document.createElement('div');
                div.className = 'dynamic-input-row medicao';
                div.innerHTML = `
                    <input type="text" value="${agent}" placeholder="Agente" class="w-full p-2 border rounded-lg">
                    <input type="text" value="${value}" placeholder="Valor" class="w-full p-2 border rounded-lg">
                    <input type="text" value="${unit}" placeholder="Unidade/Técnica" class="w-full p-2 border rounded-lg">
                    <button class="remove-btn" type="button">&times;</button>
                `;
                div.querySelector('.remove-btn').addEventListener('click', () => {
                    div.remove();
                    updateLivePreview();
                });
                div.querySelectorAll('input').forEach(input => input.addEventListener('input', updateLivePreview));
                medicaoList.appendChild(div);
            }

            function validateForm() {
                let isValid = true;
                const fieldsToValidate = [
                    { el: setorSelect, msg: 'Selecione um setor.' },
                    { el: funcaoSelect, msg: 'Selecione uma função.' }
                ];
                fieldsToValidate.forEach(field => field.el.classList.remove('blinking-border'));
                hideNotification();
                let missingFieldsMessages = [];
                fieldsToValidate.forEach(field => {
                    if (!field.el.value.trim()) {
                        isValid = false;
                        field.el.classList.add('blinking-border');
                        missingFieldsMessages.push(field.msg);
                    }
                });
                if (!isValid) {
                    showNotification('warning', 'Campos Obrigatórios!', missingFieldsMessages.join(' '));
                }
                return isValid;
            }

            function getCombinedRisks(category) {
                const selectedRisks = Array.from(document.querySelectorAll(`#risk-${category}-checkboxes input:checked`)).map(cb => cb.value);
                const otherRisk = document.getElementById(`risk-${category}-outro`).value.trim();
                if (otherRisk) selectedRisks.push(otherRisk);
                return selectedRisks.join(', ') || defaultText;
            }

            function getStructuredEpiHtml() {
                const rows = epiList.querySelectorAll('.dynamic-input-row');
                if (rows.length === 0) return `<p>${defaultText}</p>`;
                
                let tableHtml = '<table><tr><td style="font-weight: bold;">Equipamento</td><td style="font-weight: bold;">C.A.</td></tr>';
                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    const name = inputs[0].value.trim() || 'N/A';
                    const ca = inputs[1].value.trim() || 'N/A';
                    tableHtml += `<tr><td>${name}</td><td>${ca}</td></tr>`;
                });
                tableHtml += '</table>';
                return tableHtml;
            }
            
            function getStructuredMedicaoHtml() {
                const rows = medicaoList.querySelectorAll('.dynamic-input-row');
                if (rows.length === 0) return `<p>${defaultText}</p>`;

                let tableHtml = '<table><tr><td style="font-weight: bold;">Agente</td><td style="font-weight: bold;">Valor Medido</td><td style="font-weight: bold;">Unidade/Técnica</td></tr>';
                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    const agent = inputs[0].value.trim() || 'N/A';
                    const value = inputs[1].value.trim() || 'N/A';
                    const unit = inputs[2].value.trim() || 'N/A';
                    tableHtml += `<tr><td>${agent}</td><td>${value}</td><td>${unit}</td></tr>`;
                });
                tableHtml += '</table>';
                return tableHtml;
            }

            function generateOsHtmlForEmployee(employee) {
                const empresa = companyNameInput.value.trim() || '[Nome da Empresa]';
                const unidade = companyUnitInput.value.trim() || '[Unidade a ser definida]';
                const setor = setorSelect.value;
                const funcao = funcaoSelect.value;
                const atividadesText = manualAtividades.value.trim() || defaultText;
                const epiHtml = getStructuredEpiHtml();
                const medicoesHtml = getStructuredMedicaoHtml();
                
                const employeeName = findValueInObject(employee, ['Nome do Funcionário', 'Nome']) || 'N/A';
                const admissionDate = findValueInObject(employee, ['Data de Admissão']) || 'N/A';
                const formattedEmployeeName = formatAsTitle(employeeName);
                const formattedSetor = formatAsTitle(setor);
                const formattedFuncao = formatAsTitle(funcao);
                const logoHtml = logoDataUrl ? `<img src="${logoDataUrl}" alt="Logotipo" style="max-width: 150px; max-height: 80px; object-fit: contain;">` : '';

                return `
                    <p>Pela presente Ordem de serviço, objetivamos informar os trabalhadores que executam suas atividades laborais nesse setor, conforme estabelece a NR-01 , sobre as condições de segurança e saúde às quais estão expostos, de forma a padronizar comportamentos para prevenir acidentes e/ou doenças ocupacionais.</p>
                    <table class="header-table">
                        <tr>
                            <td rowspan="3" style="width: 160px; text-align: center; vertical-align: middle; border-right: 1px solid #000;">${logoHtml}</td>
                            <td colspan="2"><strong>Empresa:</strong> ${empresa}</td>
                            <td colspan="2"><strong>Unidade:</strong> ${unidade}</td>
                        </tr>
                        <tr>
                            <td colspan="2"><strong>Nome do Funcionário:</strong> ${formattedEmployeeName}</td>
                            <td colspan="2"><strong>Data de Admissão:</strong> ${admissionDate}</td>
                        </tr>
                        <tr>
                            <td colspan="2"><strong>Setor de Trabalho:</strong> ${formattedSetor}</td>
                            <td colspan="2"><strong>Função:</strong> ${formattedFuncao}</td>
                        </tr>
                    </table>
                    <h3>TAREFAS DA FUNÇÃO</h3>
                    <p>${atividadesText}</p>
                    <h3>AGENTES DE RISCOS OCUPACIONAIS - NR01 item 1.4.1 b) I / item 1.4.4 a)</h3>
                    <table>
                        <tr><td><strong>Acidente:</strong> ${getCombinedRisks('acidente')}</td><td><strong>Físico:</strong> ${getCombinedRisks('fisico')}</td></tr>
                        <tr><td><strong>Ergonômico:</strong> ${getCombinedRisks('ergonomico')}</td><td><strong>Químico:</strong> ${getCombinedRisks('quimico')}</td></tr>
                        <tr><td colspan="2"><strong>Biológico:</strong> ${getCombinedRisks('biologico')}</td></tr>
                    </table>
                    <h3>POSSÍVEIS DANOS À SAÚDE - NR01 item 1.4.1 b) I.</h3>
                    <table>
                        <tr><td><strong>Acidente:</strong> ${document.getElementById('damage-acidente').value.trim() || defaultText}</td><td><strong>Físico:</strong> ${document.getElementById('damage-fisico').value.trim() || defaultText}</td></tr>
                        <tr><td><strong>Ergonômico:</strong> ${document.getElementById('damage-ergonomico').value.trim() || defaultText}</td><td><strong>Químico:</strong> ${document.getElementById('damage-quimico').value.trim() || defaultText}</td></tr>
                        <tr><td colspan="2"><strong>Biológico:</strong> ${document.getElementById('damage-biologico').value.trim() || defaultText}</td></tr>
                    </table>
                    <h3>MEDIDAS ADOTADAS PELA EMPRESA PARA REDUZIR OS RISCOS OCUPACIONAIS NR01 item 1.4.1 b) II / item 1.4.4 c)</h3>
                    ${epiHtml}
                    <p>Treinamento e Supervisão para execução das tarefas e uso dos EPI, em especial em relação aos trabalhos em altura, com poeiras e solventes; Guarda-corpo de proteção periferias; Monitoramento do ambiente do trabalho afim de corrigir condições inseguras encontradas, imediatamente; Fornecimento de cópia de ASO informando os resultados dos exames médicos e dos exames complementares de diagnóstico aos quais os próprios trabalhadores forem submetidos; Sinalização de Segurança no ambiente de trabalho; Fornecimento, Treinamento e Exigência de uso de EPI.</p>
                    <h3>INFORME DOS RESULTADOS DAS AVALIAÇÕES AMBIENTAIS NOS LOCAIS DE TRABALHO - NR01 item 1.4.1 b) IV.</h3>
                    ${medicoesHtml}
                    <h3>PROCEDIMENTOS A SEREM ADOTADOS EM SITUAÇÃO DE ACIDENTES E EMERGÊNCIAS - NR01 item 1.4.4 d) / item 1.4.1 e)</h3>
                    <p>Comunique imediatamente o acidente à chefia imediata ou na impossibilidade à pessoa que possa acessá-la; Preserve as condições do local de acidente até a comunicação com a autoridade competente; Siga as orientações correspondentes ao acidente e com as atribuições de sua função, indicados no “Plano de Respostas aos Possíveis Cenários de Emergência”, elaborado pela empresa”.</p>
                    <h3>ORIENTAÇÕES SOBRE CONSTATAÇÃO DE GRAVE E IMINENTE RISCO - NR01 item 1.4.4 e) / item 1.4.3 / item 1.4.3.1</h3>
                    <p>Sempre que constatar Grave e Iminente Risco à Vida e/ou Saúde, sua ou de outros, interrompa de imediato e com segurança as atividades; Informe imediatamente ao seu superior hierárquico; Registre a constatação e as medidas tomadas no “Registro de Condições de Grave e Iminente Risco”, conforme procedimento padronizados pela empresa; Aguarde as providências e liberação formal do cenário pela empresa.</p>
                    <p style="margin-top: 1rem;">Conforme Art. 158 da CLT e NR-01 item 1.4.2.1, o descumprimento imotivado das disposições legais e regulamentares sobre segurança e saúde no trabalho, inclusive das ordens de serviço expedidas pelo empregador, sujeita o empregado às penalidades legais, inclusive, demissão por justa causa.</p>
                    <table style="margin-top: 2rem; width: 100%; text-align: center; border: none;"><tr style="border: none;"><td style="border: none;">___________________________<br>SESMT</td><td style="border: none;">___________________________<br>Chefia Imediata</td></tr></table>
                    <p style="margin-top: 1rem;">Cópia recebida em: ______/______/______</p>
                    <div class="signature-line" style="margin-top: 3rem;">${formattedEmployeeName}</div>
                `;
            }

            function updateLivePreview() {
                const selectedSetor = setorSelect.value;
                const selectedFuncao = funcaoSelect.value;
                if (!selectedSetor || !selectedFuncao) {
                    liveOsPreview.innerHTML = `<p class="text-center text-gray-500">A pré-visualização aparecerá aqui assim que uma função for selecionada.</p>`;
                    return;
                }
                
                const representativeEmployee = employeeData.find(emp => {
                    const empSetor = findValueInObject(emp, ['Setor']);
                    const empFuncao = findValueInObject(emp, ['Função', 'Cargo']);
                    return empSetor && empFuncao && empSetor.trim().toLowerCase() === selectedSetor.trim().toLowerCase() && empFuncao.trim().toLowerCase() === selectedFuncao.trim().toLowerCase();
                });

                if(representativeEmployee) {
                    liveOsPreview.innerHTML = generateOsHtmlForEmployee(representativeEmployee);
                } else {
                     liveOsPreview.innerHTML = `<p class="text-center text-gray-500">Selecione uma função para ver a pré-visualização.</p>`;
                }
            }
            
            function updateRiskSummary() {
                if (!documentAnalysisResult || !documentAnalysisResult.cargos) {
                    riskSummaryContainer.innerHTML = `<p class="text-gray-500">Nenhum dado de documento analisado para exibir.</p>`;
                    return;
                }

                let html = '';
                const sectors = {};
                documentAnalysisResult.cargos.forEach(cargo => {
                    const setor = cargo.setor || "Setor Não Identificado";
                    if (!sectors[setor]) {
                        sectors[setor] = [];
                    }
                    sectors[setor].push(cargo);
                });

                for (const setor in sectors) {
                    html += `<div class="p-4 border rounded-lg" style="border-color: var(--border-color);">`;
                    html += `<h4 class="text-lg font-bold">${formatAsTitle(setor)}</h4>`;
                    sectors[setor].forEach(cargo => {
                        html += `<div class="ml-4 mt-2">`;
                        html += `<p class="font-semibold">${formatAsTitle(cargo.funcao)}</p>`;
                        // Adicione mais detalhes se desejar, por exemplo, uma lista de riscos.
                        html += `</div>`;
                    });
                    html += `</div>`;
                }
                riskSummaryContainer.innerHTML = html;
            }

            
            function addToReport(data) { generatedOSReport.push(data); updateReportTable(); }
            function updateReportTable() {
                reportTableBody.innerHTML = '';
                generatedOSReport.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="py-2 px-4 border-b" style="border-color: var(--border-color);">${item.nome}</td><td class="py-2 px-4 border-b" style="border-color: var(--border-color);">${item.setor}</td><td class="py-2 px-4 border-b" style="border-color: var(--border-color);">${item.funcao}</td>`;
                    reportTableBody.appendChild(row);
                });
            }
            
            // --- LÓGICA DO CHAT ---
            function toggleChat() {
                chatModal.classList.toggle('hidden');
            }

            function addChatMessage(text, sender) {
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${sender}`;
                bubble.textContent = text;
                chatMessages.appendChild(bubble);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function handleChatSend() {
                const userInput = chatInput.value.trim();
                if (userInput === '') return;

                addChatMessage(userInput, 'user');
                chatInput.value = '';

                let response = "Desculpe, não entendi. Você pode me perguntar sobre 'funções encontradas', 'atividades do [cargo]', 'EPIs para [cargo]' ou pedir para 'identificar os riscos' para a função selecionada.";

                if (!documentAnalysisResult && !userInput.toLowerCase().includes('olá')) {
                    addChatMessage("Por favor, primeiro analise um documento de SST para que eu possa ajudá-lo.", 'ai');
                    return;
                }

                if (userInput.toLowerCase().includes('funções encontradas')) {
                    const funcoes = documentAnalysisResult.cargos.map(c => formatAsTitle(c.funcao)).join(', ');
                    response = `Encontrei as seguintes funções no documento: ${funcoes}.`;
                } else if (userInput.toLowerCase().startsWith('quais as atividades')) {
                    const cargoMatch = userInput.match(/atividades d[oae]\s+(.+)/i);
                    if (cargoMatch && cargoMatch[1]) {
                        const cargoName = cargoMatch[1].trim();
                        const cargoData = documentAnalysisResult.cargos.find(c => c.funcao.toLowerCase() === cargoName.toLowerCase());
                        response = cargoData ? `Atividades para ${formatAsTitle(cargoName)}: ${cargoData.atividades}` : `Não encontrei a função "${cargoName}" no documento.`;
                    }
                } else if (userInput.toLowerCase().startsWith('sugira epis para')) {
                     const cargoMatch = userInput.match(/epis para\s+(.+)/i);
                    if (cargoMatch && cargoMatch[1]) {
                        const cargoName = cargoMatch[1].trim();
                        const cargoData = documentAnalysisResult.cargos.find(c => c.funcao.toLowerCase() === cargoName.toLowerCase());
                        if (cargoData && cargoData.epis.length > 0) {
                            const epiListStr = cargoData.epis.map(e => `${e.nome} (C.A.: ${e.ca || 'N/A'})`).join('; ');
                            response = `EPIs para ${formatAsTitle(cargoName)}: ${epiListStr}.`;
                        } else {
                            response = `Não encontrei EPIs específicos para a função "${cargoName}" no documento.`;
                        }
                    }
                } else if (userInput.toLowerCase().includes('riscos')) {
                    const selectedFuncao = funcaoSelect.value;
                    if (!selectedFuncao) {
                        response = "Por favor, selecione um setor e uma função primeiro para que eu possa ajudar a identificar os riscos.";
                    } else {
                        response = `Ok, vou identificar e marcar os riscos mais comuns para a função de ${formatAsTitle(selectedFuncao)}. Por favor, aguarde um momento.`;
                        // Simula a busca e marcação dos riscos
                        const functionRiskMap = {
                            'Manobrista': {'acidente': ['Batida contra', 'Atropelamento', 'Queda de mesmo nível'],'ergonomico': ['Postura inadequada (sentado, em pé, agachado)']},
                            'Orientador de Tráfego': {'acidente': ['Atropelamento', 'Queda de mesmo nível'],'fisico': ['Ruído', 'Calor'],'ergonomico': ['Postura inadequada (sentado, em pé, agachado)']}
                        };
                        const risksToSelect = functionRiskMap[selectedFuncao];
                        if (risksToSelect) {
                            for (const category in risksToSelect) {
                                risksToSelect[category].forEach(riskName => {
                                    const checkbox = document.querySelector(`#risk-${category}-checkboxes input[value="${riskName}"]`);
                                    if (checkbox) checkbox.checked = true;
                                });
                            }
                            handleRiskSelectionChange();
                            updateLivePreview();
                            setTimeout(() => addChatMessage("Pronto! Marquei alguns riscos na aba 'Análise de Riscos'. Por favor, revise e ajuste se necessário.", 'ai'), 500);
                            showNotification('success', 'IA', 'Riscos selecionados pela IA na aba de Análise de Riscos.');
                        } else {
                             response = `Não tenho um mapeamento de riscos pré-definido para "${formatAsTitle(selectedFuncao)}". Por favor, preencha manualmente.`;
                        }
                    }
                } else if (userInput.toLowerCase().includes('olá') || userInput.toLowerCase().includes('oi')) {
                    response = "Olá! Como posso ajudar? Você pode me perguntar sobre as funções, atividades e EPIs encontrados no documento, ou pedir para eu identificar os riscos da função selecionada.";
                }
                
                setTimeout(() => addChatMessage(response, 'ai'), 500);
            }
            
            // --- EVENT LISTENERS ---
            xlsxInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    updateChecklist('xlsx', false);
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        employeeData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        processAndPopulateSelectors();
                        updateChecklist('xlsx', true);
                    } catch (error) {
                        showNotification('error', 'Erro de Arquivo!', 'Não foi possível ler a planilha. Verifique o formato (.xlsx) e as colunas.');
                        updateChecklist('xlsx', false);
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            setorSelect.addEventListener('change', () => {
                populateFuncaoSelect(setorSelect.value);
                updateChecklist('funcao', false);
            });

            funcaoSelect.addEventListener('change', () => {
                const selectedFuncao = funcaoSelect.value;
                const selected = selectedFuncao !== "";
                updateChecklist('funcao', selected);
                if (selected) {
                    updateDetailsFromSources();
                    updateLivePreview();
                }
            });
            
            logoInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    logoDataUrl = null;
                    updateLivePreview();
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    logoDataUrl = e.target.result;
                    updateLivePreview();
                };
                reader.readAsDataURL(file);
            });
            
            addEpiBtn.addEventListener('click', () => addEpiRow());
            addMedicaoBtn.addEventListener('click', () => addMedicaoRow());
            [manualAtividades, companyNameInput, companyUnitInput].forEach(el => el.addEventListener('input', updateLivePreview));
            
            generatePdfBtn.addEventListener('click', async () => {
                if (!validateForm()) return;

                const selectedSetor = setorSelect.value;
                const selectedFuncao = funcaoSelect.value;

                const matchingEmployees = employeeData.filter(emp => {
                    const empSetor = findValueInObject(emp, ['Setor']);
                    const empFuncao = findValueInObject(emp, ['Função', 'Cargo']);
                    return empSetor && empFuncao && empSetor.trim().toLowerCase() === selectedSetor.trim().toLowerCase() && empFuncao.trim().toLowerCase() === selectedFuncao.trim().toLowerCase();
                });

                if (matchingEmployees.length === 0) {
                    showNotification('warning', 'Nenhum Funcionário', 'Nenhum funcionário encontrado para o setor e função selecionados.');
                    return;
                }
                
                showNotification('success', 'Iniciando Geração', `Gerando OS para ${matchingEmployees.length} funcionário(s). Vários downloads serão iniciados.`);

                for (const employee of matchingEmployees) {
                    const osHtml = generateOsHtmlForEmployee(employee);
                    document.getElementById('os-preview').innerHTML = osHtml;
                    
                    const employeeName = findValueInObject(employee, ['Nome do Funcionário', 'Nome']);
                    const fileName = `OS - ${employeeName}.pdf`;
                    const options = { margin: 0.5, filename: fileName, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
                    
                    await html2pdf().from(document.getElementById('os-preview')).set(options).save();
                    
                    addToReport({ 
                        nome: formatAsTitle(employeeName), 
                        setor: formatAsTitle(selectedSetor), 
                        funcao: formatAsTitle(selectedFuncao) 
                    });
                }
            });

            // --- CÓDIGO DE INICIALIZAÇÃO ---
            createRiskCards();
            
            downloadTemplateBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const templateData = [
                    {
                        "Nome do Funcionário": "João da Silva",
                        "Data de Admissão": "01/01/2023",
                        "Setor": "Operacional",
                        "Função": "Manobrista",
                        "Descrição das Atividades": "Manobrar veículos dos clientes até as vagas demarcadas e executa atividades de orientação.",
                        "EPIs (Separados por ';')": "Sapato Social Ocupacional - C.A. - 33698"
                    },
                    {
                        "Nome do Funcionário": "Maria Oliveira",
                        "Data de Admissão": "15/03/2022",
                        "Setor": "Operacional",
                        "Função": "Orientador de Tráfego",
                        "Descrição das Atividades": "Executa atividades de orientação fornecendo informações aos condutores para garantir fluidez ao tráfego.",
                        "EPIs (Separados por ';')": "Botina de Segurança - C.A. - 45611; Capa de Chuva PVC - C.A. - 28449"
                    }
                ];
                const worksheet = XLSX.utils.json_to_sheet(templateData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Funcionários");
                XLSX.writeFile(workbook, "Modelo_Funcionarios_OS.xlsx");
            });

            // Lógica das Abas
            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Adicionado para esconder modais ao trocar de aba
                    chatModal.classList.add('hidden');

                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const target = tab.id.replace('btn', 'content');
                    tabContents.forEach(c => c.classList.add('hidden'));
                    document.getElementById(target).classList.remove('hidden');
                });
            });

            // Lógica do Modo Noturno
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }

            themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                sunIcon.classList.toggle('hidden');
                moonIcon.classList.toggle('hidden');
                if (document.documentElement.classList.contains('dark')) {
                    localStorage.setItem('theme', 'dark');
                } else {
                    localStorage.setItem('theme', 'light');
                }
            });

            // Lógica do Chat
            chatToggleBtn.addEventListener('click', toggleChat);
            chatCloseBtn.addEventListener('click', toggleChat);
            chatSendBtn.addEventListener('click', handleChatSend);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleChatSend();
                }
            });
            addChatMessage("Olá! Sou sua assistente de IA. Após analisar um documento, você pode me perguntar sobre as funções, atividades e EPIs que encontrei.", 'ai');

            // =================================================================
            // CORREÇÕES E NOVAS FUNÇÕES PARA ANÁLISE DE ARQUIVOS E IA
            // =================================================================
            
            // Função para encontrar valor em objeto com chaves case-insensitive
            function findValueInObject(obj, keys) {
                for (const key of keys) {
                    const objKey = Object.keys(obj).find(k => k.toLowerCase().trim() === key.toLowerCase().trim());
                    if (objKey) {
                        return obj[objKey];
                    }
                }
                return null;
            }

            // Mostra as opções de análise quando um arquivo é selecionado
            sstDocInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    analysisOptionsDiv.classList.remove('hidden');
                    const fileType = file.type;
                    const ocrRadio = document.getElementById('ocr-radio');
                    const directAiRadio = document.getElementById('direct-ai-radio');
                    
                    if (fileType.startsWith('image/')) {
                        ocrRadio.checked = true;
                        directAiRadio.checked = false;
                    } else if (fileType === 'application/pdf') {
                        // Deixa o usuário escolher, pois pode ser PDF de texto ou imagem
                        ocrRadio.checked = false;
                        directAiRadio.checked = true;
                    }
                } else {
                    analysisOptionsDiv.classList.add('hidden');
                }
            });

            // Inicia a análise quando o botão é clicado
            startAnalysisBtn.addEventListener('click', async () => {
                const file = sstDocInput.files[0];
                const analysisMethod = document.querySelector('input[name="analysis-method"]:checked');

                if (!file || !analysisMethod) {
                    showNotification('warning', 'Atenção!', 'Por favor, selecione um arquivo e um método de análise.');
                    return;
                }

                aiStatus.innerHTML = '<div class="loader"></div><span>Analisando documento...</span>';
                progressContainer.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                startAnalysisBtn.disabled = true;

                try {
                    let textContent = '';
                    if (analysisMethod.value === 'ocr') {
                        textContent = await getTextFromOcr(file);
                    } else {
                        textContent = await getTextFromPdf(file);
                    }

                    if (!textContent.trim()) {
                       throw new Error("Não foi possível extrair texto do documento. Se for um PDF escaneado, tente a análise via OCR.");
                    }
                    
                    progressBar.style.width = '50%';
                    progressBar.textContent = '50%';
                    aiStatus.innerHTML = '<div class="loader"></div><span>IA processando o texto extraído...</span>';

                    const prompt = `
                        Você é um especialista em Saúde e Segurança do Trabalho (SST). Analise o texto extraído de um documento de SST (como PGR, LTCAT, etc.) e retorne uma estrutura JSON.
                        O JSON deve conter uma chave principal "cargos", que é um array de objetos.
                        Cada objeto nesse array deve representar uma função/cargo e conter as seguintes chaves: "setor", "funcao", "atividades", "epis" (um array de objetos com "nome" e "ca"), e "medicoes" (um array de objetos com "agente", "valor" e "unidade").
                        Extraia as informações da forma mais precisa possível do texto abaixo. Se uma informação não for encontrada para um cargo, retorne uma string vazia ou um array vazio.

                        Texto do documento:
                        ---
                        ${textContent}
                        ---
                    `;

                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    cargos: {
                                        type: "ARRAY",
                                        items: {
                                            type: "OBJECT",
                                            properties: {
                                                setor: { type: "STRING" },
                                                funcao: { type: "STRING" },
                                                atividades: { type: "STRING" },
                                                epis: {
                                                    type: "ARRAY",
                                                    items: {
                                                        type: "OBJECT",
                                                        properties: {
                                                            nome: { type: "STRING" },
                                                            ca: { type: "STRING" }
                                                        }
                                                    }
                                                },
                                                medicoes: {
                                                    type: "ARRAY",
                                                    items: {
                                                        type: "OBJECT",
                                                        properties: {
                                                            agente: { type: "STRING" },
                                                            valor: { type: "STRING" },
                                                            unidade: { type: "STRING" }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    };

                    documentAnalysisResult = await executeGeminiAnalysis(payload, true);
                    
                    progressBar.style.width = '100%';
                    progressBar.textContent = '100%';
                    aiStatus.innerHTML = '<span>&#10003; Análise concluída com sucesso!</span>';
                    showNotification('success', 'Sucesso!', 'Documento analisado. Verifique os campos preenchidos e o resumo de riscos.');
                    updateChecklist('doc', true);
                    
                    // Tenta pré-selecionar o setor/função
                    autoSelectRoleAfterAnalysis();
                    updateRiskSummary();

                } catch (error) {
                    console.error("Erro na análise:", error);
                    aiStatus.innerHTML = `<span>&#10060; Erro na análise: ${error.message}</span>`;
                    showNotification('error', 'Erro de Análise', error.message);
                    updateChecklist('doc', false);
                } finally {
                    startAnalysisBtn.disabled = false;
                }
            });

            // Função para extrair texto de PDF (usando PDF.js)
            async function getTextFromPdf(file) {
                const reader = new FileReader();
                return new Promise((resolve, reject) => {
                    reader.onload = async (event) => {
                        try {
                            const pdfData = new Uint8Array(event.target.result);
                            const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                            let fullText = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                fullText += textContent.items.map(item => item.str).join(' ');
                                updateProgressBar((i / pdf.numPages) * 40, `Extraindo texto da página ${i}...`);
                            }
                            resolve(fullText);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }

            // Função para extrair texto de imagem (usando Tesseract.js)
            async function getTextFromOcr(file) {
                const worker = await Tesseract.createWorker('por', 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                           updateProgressBar(m.progress * 40, 'Reconhecendo texto...');
                        }
                    },
                });
                const { data: { text } } = await worker.recognize(file);
                await worker.terminate();
                return text;
            }

            // Função para atualizar a barra de progresso
            function updateProgressBar(percentage, text) {
                const p = Math.round(percentage);
                progressBar.style.width = `${p}%`;
                progressBar.textContent = `${p}%`;
                aiStatus.innerHTML = `<div class="loader"></div><span>${text}</span>`;
            }

            // Função para chamar a API do Gemini
            async function executeGeminiAnalysis(payload, isJson = false) {
                 const apiKey = ""; // Deixe em branco, será tratado pelo ambiente
                 const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                
                 const response = await fetch(apiUrl, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(payload)
                 });

                 if (!response.ok) {
                     const errorBody = await response.json();
                     throw new Error(`Erro da API: ${errorBody.error?.message || response.statusText}`);
                 }

                 const result = await response.json();
                 const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                 if (!text) {
                     throw new Error("A IA não retornou uma resposta válida.");
                 }

                 if (isJson) {
                     try {
                         return JSON.parse(text);
                     } catch (e) {
                         throw new Error("A resposta da IA não é um JSON válido.");
                     }
                 }
                 return text;
            }
            
            // Tenta selecionar o primeiro cargo encontrado na análise
            function autoSelectRoleAfterAnalysis() {
                if (!documentAnalysisResult || !documentAnalysisResult.cargos || documentAnalysisResult.cargos.length === 0) {
                    return;
                }
                const firstRole = documentAnalysisResult.cargos[0];
                if (firstRole.setor && firstRole.funcao) {
                    setorSelect.value = firstRole.setor;
                    populateFuncaoSelect(firstRole.setor);
                    funcaoSelect.value = firstRole.funcao;
                    
                    // Dispara o evento change para carregar os dados
                    funcaoSelect.dispatchEvent(new Event('change'));
                }
            }

        });
    </script>
</body>
</html>
