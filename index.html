<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Ordem de Serviço (OS) com OCR Avançado</title>
    <!-- Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) para ler arquivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- html2pdf.js para gerar PDFs a partir de HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Tesseract.js para OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); padding: 2rem; margin-bottom: 2rem; }
        .btn { transition: all 0.3s ease; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .risk-checkbox-container { max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem; background-color: #f7fafc; }
        .risk-checkbox-container label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        #os-preview { font-family: 'Times New Roman', Times, serif; color: #000; background: #fff; padding: 2rem; border: 1px solid #ccc; line-height: 1.5; }
        #os-preview h2, #os-preview h3 { font-weight: bold; text-align: center; margin-top: 1rem; margin-bottom: 0.5rem; font-size: 12pt; }
        #os-preview p { text-align: justify; margin-bottom: 1rem; font-size: 11pt; }
        #os-preview table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; font-size: 11pt; }
        #os-preview td { border: 1px solid #000; padding: 4px 8px; vertical-align: top; }
        #os-preview .header-table td { font-weight: bold; }
        #os-preview .signature-line { border-top: 1px solid #000; margin-top: 3rem; text-align: center; padding-top: 0.5rem; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 24px; height: 24px; animation: spin 2s linear infinite; }
        .blinking-border { animation: blink 1s 3; }
        @keyframes blink { 50% { border-color: #ef4444; box-shadow: 0 0 10px #ef4444; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Gerador Automatizado de Ordem de Serviço</h1>
            <p class="text-lg text-gray-600 mt-2">Carregue os dados, analise os riscos e gere a OS com relatório.</p>
        </header>

        <!-- Área de Notificação -->
        <div id="notification-area" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert">
            <span class="font-medium" id="notification-title"></span> <span id="notification-message"></span>
        </div>

        <!-- Passo 1: Carregar Dados -->
        <div class="card">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Passo 1: Carregar Arquivos</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <label for="xlsx-input" class="block mb-2 font-medium text-gray-700">1.1 - Planilha de Funcionários (.xlsx):</label>
                    <input type="file" id="xlsx-input" accept=".xlsx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                    <p class="text-xs text-gray-500 mt-1">Colunas: 'Nome do Funcionário', 'Data de Admissão'.</p>
                    <label for="employee-select" class="block mt-4 mb-2 font-medium text-gray-700">Funcionário:</label>
                    <select id="employee-select" disabled class="w-full p-2 border border-gray-300 rounded-lg bg-gray-200 cursor-not-allowed transition-all duration-300">
                        <option>Aguardando planilha...</option>
                    </select>
                </div>
                <div>
                    <label for="sst-doc-input" class="block mb-2 font-medium text-gray-700">1.2 - Documento de SST (PGR, etc.):</label>
                    <input type="file" id="sst-doc-input" accept="image/*,application/pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                    <div id="ocr-status" class="mt-2 text-sm flex items-center gap-2"></div>
                </div>
            </div>
        </div>

        <!-- Passo 2: Validar Dados Extraídos -->
        <div id="validation-card" class="card hidden">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Passo 2: Validar Dados Extraídos do Documento</h2>
            <p class="text-sm text-gray-600 mb-4">O sistema extraiu as informações abaixo. Revise, corrija ou complete conforme necessário.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="manual-setor" class="block text-sm font-medium">Setor:</label>
                    <input type="text" id="manual-setor" class="w-full p-2 border border-gray-300 rounded-lg transition-all duration-300">
                </div>
                <div>
                    <label for="manual-funcao" class="block text-sm font-medium">Função:</label>
                    <input type="text" id="manual-funcao" class="w-full p-2 border border-gray-300 rounded-lg transition-all duration-300">
                </div>
                <div class="md:col-span-2">
                    <label for="manual-epi" class="block text-sm font-medium">EPIs (Equipamentos de Proteção Individual):</label>
                    <textarea id="manual-epi" rows="3" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Nenhuma informação de EPI encontrada. Adicione manualmente se necessário."></textarea>
                </div>
                <div class="md:col-span-2">
                    <label for="manual-medicoes" class="block text-sm font-medium">Medições Ambientais:</label>
                    <textarea id="manual-medicoes" rows="3" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Nenhuma medição encontrada. Adicione manualmente se necessário."></textarea>
                </div>
            </div>
        </div>

        <!-- Passo 3: Análise de Riscos -->
        <div class="card">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Passo 3: Análise de Riscos</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Conteúdo dos riscos aqui... -->
                 <div>
                    <label class="block mb-1 font-medium text-sm">Risco Físico:</label>
                    <div id="risk-fisico-checkboxes" class="risk-checkbox-container mb-2"></div>
                    <textarea id="risk-fisico-outro" rows="1" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Outro risco físico..."></textarea>
                    <label for="damage-fisico" class="block mb-1 mt-2 font-medium text-sm">Dano (Físico):</label>
                    <textarea id="damage-fisico" rows="2" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Danos serão preenchidos automaticamente..."></textarea>
                </div>
                <div>
                    <label class="block mb-1 font-medium text-sm">Risco Químico:</label>
                    <div id="risk-quimico-checkboxes" class="risk-checkbox-container mb-2"></div>
                    <textarea id="risk-quimico-outro" rows="1" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Outro risco químico..."></textarea>
                    <label for="damage-quimico" class="block mb-1 mt-2 font-medium text-sm">Dano (Químico):</label>
                    <textarea id="damage-quimico" rows="2" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Danos serão preenchidos automaticamente..."></textarea>
                </div>
                <div>
                    <label class="block mb-1 font-medium text-sm">Risco Biológico:</label>
                    <div id="risk-biologico-checkboxes" class="risk-checkbox-container mb-2"></div>
                    <textarea id="risk-biologico-outro" rows="1" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Outro risco biológico..."></textarea>
                    <label for="damage-biologico" class="block mb-1 mt-2 font-medium text-sm">Dano (Biológico):</label>
                    <textarea id="damage-biologico" rows="2" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Danos serão preenchidos automaticamente..."></textarea>
                </div>
                <div>
                    <label class="block mb-1 font-medium text-sm">Risco de Acidente:</label>
                    <div id="risk-acidente-checkboxes" class="risk-checkbox-container mb-2"></div>
                    <textarea id="risk-acidente-outro" rows="1" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Outro risco de acidente..."></textarea>
                    <label for="damage-acidente" class="block mb-1 mt-2 font-medium text-sm">Dano (Acidente):</label>
                    <textarea id="damage-acidente" rows="2" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Danos serão preenchidos automaticamente..."></textarea>
                </div>
                <div class="md:col-span-2">
                    <label for="risk-ergonomico" class="block mb-1 font-medium text-sm">Risco Ergonômico:</label>
                    <textarea id="risk-ergonomico" rows="2" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Ex: Postura inadequada, esforço repetitivo..."></textarea>
                    <label for="damage-ergonomico" class="block mb-1 mt-2 font-medium text-sm">Dano (Ergonômico):</label>
                    <textarea id="damage-ergonomico" rows="2" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Ex: LER/DORT, dores musculares..."></textarea>
                </div>
            </div>
        </div>

        <!-- Passo 4: Gerar OS e Relatório -->
        <div class="card">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Passo 4: Gerar OS e Relatório</h2>
            <div class="text-center mb-8">
                <button id="generate-pdf-btn" disabled class="btn bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Gerar PDF da Ordem de Serviço
                </button>
            </div>
            <h3 class="text-xl font-semibold mb-4">Relatório de OS Geradas (nesta sessão)</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-2 px-4 border-b text-left">Nome do Funcionário</th>
                            <th class="py-2 px-4 border-b text-left">Setor</th>
                            <th class="py-2 px-4 border-b text-left">Função</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Área de Pré-visualização (oculta) -->
        <div id="os-container" class="hidden"><div id="os-preview"></div></div>
    </div>

    <script>
        // --- BANCO DE DADOS DE RISCOS E DANOS ---
        const riskData = {
            fisico: {
                "Ruído": ["Perda Auditiva Induzida pelo Ruído Ocupacional (PAIRO)."], "Calor": [], "Frio": [],
                "Pressões anormais": ["Embolia gasosa", "Danos pulmonares", "Doença descompressiva"],
                "Radiações ionizantes": ["Dano às células do corpo humano, causando doenças graves, inclusive fatais, como câncer."],
                "Radiações não-ionizantes": ["Depressão imunológica", "fotoenvelhecimento", "lesões oculares como ceratoconjuntivite", "pterígio e catarata", "Doenças graves, inclusive fatais, como câncer."],
                "Umidade": ["Doenças de pele", "Micoses", "Doenças respiratórias"],
                "Vibrações localizadas (mão/braço)": ["Alterações articulares e vasomotoras."],
                "Vibração de corpo inteiro (AREN)": ["Alterações no sistema digestivo", "sistema musculoesquelético", "sistema nervoso", "alterações na visão", "enjoos", "náuseas", "palidez."],
                "Vibração de corpo inteiro (VDVR)": ["Alterações no sistema digestivo", "sistema musculoesquelético", "sistema nervoso", "alterações na visão", "enjoos", "náuseas", "palidez."],
                "Ambiente Artificialmente Frio": ["Estresse", "desconforto", "dormência", "rigidez nas partes com maior intensidade de exposição ao frio", "redução da destreza", "formigamento", "redução da sensibilidade dos dedos e flexibilidade das articulações."],
                "Trabalhos com perfuratrizes e marteletes pneumáticos": ["PAIR", "Problemas articulares e de coluna"],
            },
            quimico: {
                "Arsênio e seus compostos": ["Intoxicação", "Câncer de pele e pulmão"], "Asbestos (ou amianto)": ["Asbestose", "Mesotelioma", "Câncer de pulmão"],
                "Benzeno e seus compostos tóxicos": ["Leucemia", "Anemia", "Danos ao sistema nervoso"], "Berílio e seus compostos tóxicos": ["Beriliose", "Doença pulmonar crônica"],
                "Bromo e seus compostos tóxicos": [], "Cádmio e seus compostos tóxicos": ["Danos renais", "Enfisema pulmonar"], "Carvão mineral e seus derivados": [],
                "Chumbo e seus compostos tóxicos": ["Saturnismo", "Danos neurológicos e renais"], "Cloro e seus compostos tóxicos": [], "Cromo e seus compostos tóxicos": [],
                "Fósforo e seus compostos tóxicos": [], "Hidrocarbonetos e outros compostos de carbono": [], "Iodo": [], "Manganês e seus compostos": [],
                "Mercúrio e seus compostos": ["Hidrargirismo", "Danos neurológicos e renais"], "Níquel e seus compostos tóxicos": ["Dermatite de contato", "Câncer de pulmão e nasal"],
                "Petróleo, xisto betuminoso, gás natural e seus derivados": [], "Sílica livre": ["Silicose", "Doença pulmonar obstrutiva crônica (DPOC)"],
                "Outras substâncias químicas": ["Irritação/lesão ocular, na pele e mucosas", "Dermatites", "Queimadura Química", "Intoxicação", "Náuseas", "Vômitos."]
            },
            biologico: {
                "Trabalhos em estabelecimentos de saúde com contato com pacientes portadores de doenças infectocontagiosas ou com manuseio de materiais contaminados": ["Hepatites", "Tuberculose", "HIV", "COVID-19"],
                "Trabalhos com animais infectados para tratamento ou para o preparo de soro, vacinas e outros produtos": ["Brucelose", "Toxoplasmose", "Raiva"],
                "Trabalhos em laboratórios de autópsia, de anatomia e anátomo-histologia": ["Infecções diversas", "Contaminação por material biológico"],
                "Trabalho de exumação de corpos e manipulação de resíduos de animais deteriorados": ["Infecções", "Contaminação"],
                "Trabalhos em galerias, fossas e tanques de esgoto": ["Leptospirose", "Hepatite A", "Infecções gastrointestinais"], "Esvaziamento de biodigestores": [],
                "Coleta e industrialização do lixo": ["Tétano", "Hepatites", "Infecções de pele"]
            },
            acidente: {
                "Abrasão e/ou escoriação": ["Lesão na pele ou mucosa."], "Agentes cortantes e/ou perfurantes": ["Corte, ferimento, perfuração."],
                "Atropelamento": ["Prensamento ou aprisionamento de partes do corpo", "cortes", "escoriações", "luxações", "fraturas", "amputações."],
                "Batida contra": ["Escoriações", "luxações", "fraturas", "traumatismo craniano."],
                "Contato com animais peçonhentos": ["Reações alérgicas", "choque anafilático", "queimaduras", "intoxicação."],
                "Eletricidade": ["Queimadura de 1º, 2º ou 3º grau", "choque elétrico", "fibrilação ventricular", "parada cardiorrespiratória."],
                "Explosão": ["Queimadura de 1º, 2º ou 3º grau", "projeção de estilhaços", "cortes", "escoriações", "luxações", "fraturas", "amputações."],
                "Incêndio": ["Queimadura de 1º, 2º ou 3º grau", "asfixia", "intoxicação por gases."], "Projeção de partículas": ["Lesão ocular", "corte", "ferimento", "perfuração."],
                "Queda de mesmo nível": ["Escoriações", "luxações", "fraturas", "traumatismo craniano."], "Queda de nível diferente": ["Escoriações", "luxações", "fraturas", "traumatismo craniano", "lesão medular."],
                "Queda de objetos": ["Prensamento ou aprisionamento de partes do corpo", "cortes", "escoriações", "luxações", "fraturas", "amputações."],
                "Soterramento": ["Asfixia", "desconforto respiratório", "nível de consciência alterado", "letargia", "palidez", "pele azulada", "tosse", "transtorno neurológico."],
                "Trabalho em espaços confinados": ["Asfixia", "hiperóxia", "contaminação por poeiras e/ou gases tóxicos", "queimadura", "afogamento."]
            }
        };

        // --- LÓGICA DA APLICAÇÃO ---
        let employeeData = [];
        let generatedOSReport = [];
        const defaultText = "Não identificado no momento da avaliação.";

        // DOM Elements
        const notificationArea = document.getElementById('notification-area');
        const notificationTitle = document.getElementById('notification-title');
        const notificationMessage = document.getElementById('notification-message');
        const xlsxInput = document.getElementById('xlsx-input');
        const employeeSelect = document.getElementById('employee-select');
        const sstDocInput = document.getElementById('sst-doc-input');
        const ocrStatus = document.getElementById('ocr-status');
        const validationCard = document.getElementById('validation-card');
        const manualSetor = document.getElementById('manual-setor');
        const manualFuncao = document.getElementById('manual-funcao');
        const manualEpi = document.getElementById('manual-epi');
        const manualMedicoes = document.getElementById('manual-medicoes');
        const generatePdfBtn = document.getElementById('generate-pdf-btn');
        const reportTableBody = document.getElementById('report-table-body');

        function showNotification(type, title, message) {
            notificationArea.className = 'p-4 mb-4 text-sm rounded-lg'; // Reset classes
            let typeClasses = '';
            if (type === 'error') typeClasses = 'bg-red-100 text-red-700';
            else if (type === 'warning') typeClasses = 'bg-yellow-100 text-yellow-700';
            else typeClasses = 'bg-green-100 text-green-700';
            notificationArea.classList.add(...typeClasses.split(' '));
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
        }

        function hideNotification() { notificationArea.classList.add('hidden'); }

        function populateRiskCheckboxes() {
            for (const category in riskData) {
                const container = document.getElementById(`risk-${category}-checkboxes`);
                if (container) {
                    const sortedRisks = Object.keys(riskData[category]).sort();
                    for (const risk of sortedRisks) {
                        const label = document.createElement('label');
                        label.className = 'flex items-center space-x-2 cursor-pointer';
                        const input = document.createElement('input');
                        input.type = 'checkbox'; input.value = risk; input.dataset.category = category;
                        input.className = 'rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-200';
                        const span = document.createElement('span'); span.textContent = risk;
                        label.appendChild(input); label.appendChild(span); container.appendChild(label);
                        input.addEventListener('change', handleRiskSelectionChange);
                    }
                }
            }
        }
        
        function handleRiskSelectionChange() {
            const categories = ['fisico', 'quimico', 'biologico', 'acidente'];
            categories.forEach(category => {
                const damageTextarea = document.getElementById(`damage-${category}`);
                const allDamages = new Set();
                document.querySelectorAll(`#risk-${category}-checkboxes input:checked`).forEach(checkbox => {
                    const risk = checkbox.value;
                    const damages = riskData[category][risk] || [];
                    damages.forEach(damage => allDamages.add(damage));
                });
                damageTextarea.value = Array.from(allDamages).join(', ');
            });
        }

        xlsxInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    employeeData = XLSX.utils.sheet_to_json(worksheet);
                    populateEmployeeSelect();
                } catch (error) {
                    console.error("Erro ao ler a planilha:", error);
                    showNotification('error', 'Erro de Arquivo!', 'Não foi possível ler a planilha. Verifique se o formato (.xlsx) e as colunas estão corretos.');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function populateEmployeeSelect() {
            employeeSelect.innerHTML = '<option value="">-- Selecione um funcionário --</option>';
            employeeData.forEach((employee, index) => {
                const employeeName = employee['Nome do Funcionário'];
                if (employeeName) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = employeeName;
                    employeeSelect.appendChild(option);
                }
            });
            employeeSelect.disabled = false;
            employeeSelect.classList.remove('bg-gray-200', 'cursor-not-allowed');
        }

        sstDocInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            ocrStatus.innerHTML = '<div class="loader"></div> <span>Processando documento... Pode levar alguns instantes.</span>';
            validationCard.classList.add('hidden');
            hideNotification();
            try {
                const { data: { text } } = await Tesseract.recognize(file, 'por');
                parseOCRText(text);
            } catch (error) {
                console.error("Erro no OCR:", error);
                ocrStatus.textContent = '';
                showNotification('error', 'Erro de OCR!', 'Ocorreu uma falha ao tentar ler o documento. Por favor, insira os dados manualmente.');
                validationCard.classList.remove('hidden');
            }
        });
        
        function extractSection(text, keywords, stopKeywords) {
            const textLower = text.toLowerCase();
            let startIndex = -1;
            for (const keyword of keywords) {
                startIndex = textLower.indexOf(keyword.toLowerCase());
                if (startIndex !== -1) break;
            }

            if (startIndex === -1) return '';

            let endIndex = text.length;
            for (const stopKeyword of stopKeywords) {
                const potentialEndIndex = textLower.indexOf(stopKeyword.toLowerCase(), startIndex + 1);
                if (potentialEndIndex !== -1) {
                    endIndex = Math.min(endIndex, potentialEndIndex);
                }
            }
            
            // Tenta pegar o texto após o ':' e até o final da linha ou seção
            let content = text.substring(startIndex, endIndex);
            const colonIndex = content.indexOf(':');
            if(colonIndex !== -1) {
                content = content.substring(colonIndex + 1);
            }
            
            return content.replace(/(\r\n|\n|\r)/gm, " ").replace(/\s+/g, ' ').trim();
        }


        function parseOCRText(text) {
            const lines = text.split('\n');
            let setor = ''; let funcao = '';
            const setorRegex = /(?:setor|área|departamento)\s*[:\-]?\s*(.+)/i;
            const funcaoRegex = /(?:função|cargo)\s*[:\-]?\s*(.+)/i;
            for (const line of lines) {
                const setorMatch = line.match(setorRegex);
                if (setorMatch && !setor) setor = setorMatch[1].trim();
                const funcaoMatch = line.match(funcaoRegex);
                if (funcaoMatch && !funcao) funcao = funcaoMatch[1].trim();
            }

            const allStopKeywords = ['riscos', 'danos', 'procedimentos', 'orientações', 'assinatura', 'data'];
            const epis = extractSection(text, ['EPI:', 'Equipamentos de Proteção Individual'], allStopKeywords);
            const medicoes = extractSection(text, ['Medições', 'Avaliações Ambientais', 'Resultados das Avaliações'], allStopKeywords);

            ocrStatus.textContent = `✅ Documento processado. Valide os dados abaixo.`;
            manualSetor.value = setor;
            manualFuncao.value = funcao;
            manualEpi.value = epis;
            manualMedicoes.value = medicoes;
            validationCard.classList.remove('hidden');
            
            checkFormReadiness();
        }

        function checkFormReadiness() {
            const employeeSelected = employeeSelect.value !== "";
            const setor = manualSetor.value.trim();
            const funcao = manualFuncao.value.trim();
            generatePdfBtn.disabled = !(employeeSelected && setor && funcao);
        }

        [employeeSelect, manualSetor, manualFuncao].forEach(el => el.addEventListener('input', checkFormReadiness));

        function validateForm() {
            let isValid = true;
            const fieldsToValidate = [
                { el: employeeSelect, msg: 'Selecione um funcionário.' },
                { el: manualSetor, msg: 'Preencha o campo Setor.' },
                { el: manualFuncao, msg: 'Preencha o campo Função.' }
            ];
            
            fieldsToValidate.forEach(field => field.el.classList.remove('blinking-border'));
            hideNotification();

            let missingFieldsMessages = [];
            fieldsToValidate.forEach(field => {
                if (!field.el.value.trim()) {
                    isValid = false;
                    field.el.classList.add('blinking-border');
                    missingFieldsMessages.push(field.msg);
                }
            });

            if (!isValid) {
                showNotification('warning', 'Campos Obrigatórios!', missingFieldsMessages.join(' '));
            }
            return isValid;
        }

        generatePdfBtn.addEventListener('click', () => {
            if (!validateForm()) return;
            try {
                const selectedIndex = employeeSelect.value;
                const employee = employeeData[selectedIndex];
                const setor = manualSetor.value.trim();
                const funcao = manualFuncao.value.trim();
                
                updatePreview(employee, setor, funcao);

                const employeeName = employee['Nome do Funcionário'];
                const fileName = `OS - ${employeeName}.pdf`;
                const options = { margin: 0.5, filename: fileName, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
                const osPreviewContent = document.getElementById('os-preview');
                html2pdf().from(osPreviewContent).set(options).save().then(() => {
                    addToReport({ nome: employeeName, setor, funcao });
                });
            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                showNotification('error', 'Erro na Geração do PDF!', 'Não foi possível criar o arquivo PDF. Tente novamente.');
            }
        });
        
        function getCombinedRisks(category) {
            const selectedRisks = Array.from(document.querySelectorAll(`#risk-${category}-checkboxes input:checked`)).map(cb => cb.value);
            const otherRisk = document.getElementById(`risk-${category}-outro`).value.trim();
            if (otherRisk) selectedRisks.push(otherRisk);
            return selectedRisks.join(', ') || defaultText;
        }

        function updatePreview(employee, setor, funcao) {
            const previewContainer = document.getElementById('os-preview');
            const epiText = manualEpi.value.trim() || 'Não identificado no momento da avaliação.';
            const medicoesText = manualMedicoes.value.trim() || 'Não identificado no momento da avaliação.';

            previewContainer.innerHTML = `
                <h2>ORDEM DE SERVIÇO - SEGURANÇA E SAÚDE NO TRABALHO (NR-01)</h2>
                <p>Pela presente Ordem de serviço, objetivamos informar os trabalhadores que executam suas atividades laborais nesse setor, conforme estabelece a NR-01, sobre as condições de segurança e saúde às quais estão expostos, de forma a padronizar comportamentos para prevenir acidentes e/ou doenças ocupacionais.</p>
                <table class="header-table">
                    <tr><td colspan="2"><strong>Empresa:</strong> Bombril</td><td colspan="2"><strong>Unidade:</strong> [Unidade a ser definida]</td></tr>
                    <tr><td colspan="2"><strong>Nome do Funcionário:</strong> ${employee['Nome do Funcionário'] || 'N/A'}</td><td colspan="2"><strong>Data de Admissão:</strong> ${employee['Data de Admissão'] || 'N/A'}</td></tr>
                    <tr><td colspan="2"><strong>Setor de Trabalho:</strong> ${setor}</td><td colspan="2"><strong>Função:</strong> ${funcao}</td></tr>
                </table>
                <h3>AGENTES DE RISCOS OCUPACIONAIS</h3>
                <table>
                    <tr><td><strong>Físico:</strong> ${getCombinedRisks('fisico')}</td><td><strong>Acidente:</strong> ${getCombinedRisks('acidente')}</td></tr>
                    <tr><td><strong>Químico:</strong> ${getCombinedRisks('quimico')}</td><td><strong>Biológico:</strong> ${getCombinedRisks('biologico')}</td></tr>
                    <tr><td colspan="2"><strong>Ergonômicos:</strong> ${document.getElementById('risk-ergonomico').value.trim() || defaultText}</td></tr>
                </table>
                <h3>POSSÍVEIS DANOS À SAÚDE</h3>
                <table>
                    <tr><td><strong>Físico:</strong> ${document.getElementById('damage-fisico').value.trim() || defaultText}</td><td><strong>Acidente:</strong> ${document.getElementById('damage-acidente').value.trim() || defaultText}</td></tr>
                    <tr><td><strong>Químico:</strong> ${document.getElementById('damage-quimico').value.trim() || defaultText}</td><td><strong>Biológico:</strong> ${document.getElementById('damage-biologico').value.trim() || defaultText}</td></tr>
                    <tr><td colspan="2"><strong>Ergonômicos:</strong> ${document.getElementById('damage-ergonomico').value.trim() || defaultText}</td></tr>
                </table>
                <h3>MEIOS PARA O EMPREGADO PREVENIR E CONTROLAR OS RISCOS OCUPACIONAIS</h3>
                <p>"Barreira física, Protetor auricular silicone tipo plug; Insufladores / Exaustores / Ventilação natural..."</p>
                <h3>MEDIDAS ADOTADAS PELA EMPRESA</h3>
                <p><strong>EPI:</strong> ${epiText}</p>
                <p>"Treinamento e Supervisão para execução das tarefas e uso dos EPI..."</p>
                <h3>INFORME DOS RESULTADOS DAS AVALIAÇÕES AMBIENTAIS</h3>
                <p>${medicoesText}</p>
                <p style="margin-top: 1rem;">Conforme Art. 158 da CLT e NR-01 item 1.4.2.1...</p>
                <table style="margin-top: 2rem; width: 100%; text-align: center; border: none;"><tr style="border: none;"><td style="border: none;">___________________________<br>SESMT</td><td style="border: none;">___________________________<br>Chefia Imediata</td></tr></table>
                <p style="margin-top: 1rem;">Cópia recebida em: ______/______/______</p>
                <div class="signature-line" style="margin-top: 3rem;">${employee['Nome do Funcionário'] || 'N/A'}</div>
            `;
        }
        
        function addToReport(data) {
            generatedOSReport.push(data);
            updateReportTable();
        }

        function updateReportTable() {
            reportTableBody.innerHTML = '';
            generatedOSReport.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="py-2 px-4 border-b">${item.nome}</td><td class="py-2 px-4 border-b">${item.setor}</td><td class="py-2 px-4 border-b">${item.funcao}</td>`;
                reportTableBody.appendChild(row);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateRiskCheckboxes();
        });
    </script>
</body>
</html>
