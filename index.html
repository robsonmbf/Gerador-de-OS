<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Ordem de Serviço (OS) com OCR Avançado</title>
    <!-- Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) para ler arquivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- html2pdf.js para gerar PDFs a partir de HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Tesseract.js para OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        /* Definição de variáveis de cor para os temas claro e escuro */
        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --header-text-color: #111827;
            --card-bg-color: #ffffff;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-color: #e5e7eb;
            --input-bg-color: #ffffff;
            --input-placeholder-color: #9ca3af;
            --tab-inactive-color: #6b7280;
            --tab-active-color: #2563eb;
            --tab-active-bg: #eff6ff;
            --progress-bg: #e5e7eb;
            --progress-fill: #3b82f6;

            /* Cores dos Riscos - Modo Claro */
            --risk-acidente-color: #2563eb;  /* Azul */
            --risk-ergonomico-color: #ca8a04; /* Amarelo */
            --risk-quimico-color: #dc2626;   /* Vermelho */
            --risk-fisico-color: #16a34a;    /* Verde */
            --risk-biologico-color: #b45309; /* Marrom (Ambar) */
        }

        .dark {
            --bg-color: #111827;
            --text-color: #d1d5db;
            --header-text-color: #ffffff;
            --card-bg-color: #1f2937;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --border-color: #374151;
            --input-bg-color: #374151;
            --input-placeholder-color: #6b7280;
            --tab-inactive-color: #9ca3af;
            --tab-active-color: #60a5fa;
            --tab-active-bg: #1e293b;
            --progress-bg: #374151;
            --progress-fill: #60a5fa;
            
            /* Cores dos Riscos - Modo Escuro (mais claras para contraste) */
            --risk-acidente-color: #60a5fa;    /* Azul Claro */
            --risk-ergonomico-color: #facc15;   /* Amarelo Claro */
            --risk-quimico-color: #f87171;     /* Vermelho Claro */
            --risk-fisico-color: #4ade80;      /* Verde Claro */
            --risk-biologico-color: #f59e0b;   /* Marrom/Ambar Claro */
        }

        body { 
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .header-text { color: var(--header-text-color); }
        .card { 
            background-color: var(--card-bg-color); 
            box-shadow: var(--card-shadow);
            transition: background-color 0.3s;
        }
        .btn { transition: all 0.3s ease; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .risk-checkbox-container { 
            height: 200px; /* Altura fixa para melhor alinhamento */
            overflow-y: auto; 
            border: 1px solid var(--border-color); 
            background-color: var(--bg-color);
            border-radius: 0.5rem; 
            padding: 0.75rem; 
        }
        #os-preview, #live-os-preview { 
            font-family: 'Times New Roman', Times, serif; 
            color: #000; 
            background: #fff; 
            padding: 2rem; 
            border: 1px solid #ccc; 
            line-height: 1.5; 
        }
        #os-preview h2, #os-preview h3, #live-os-preview h2, #live-os-preview h3 { 
            font-weight: bold; text-align: center; margin-top: 1rem; margin-bottom: 0.5rem; font-size: 12pt; 
        }
        #os-preview p, #live-os-preview p { 
            text-align: justify; margin-bottom: 1rem; font-size: 11pt; 
        }
        #os-preview table, #live-os-preview table { 
            width: 100%; border-collapse: collapse; margin-bottom: 1rem; font-size: 11pt; 
        }
        #os-preview td, #live-os-preview td { 
            border: 1px solid #000; padding: 4px 8px; vertical-align: top; 
        }
        #os-preview .header-table td, #live-os-preview .header-table td { 
            font-weight: bold; 
        }
        #os-preview .signature-line, #live-os-preview .signature-line { 
            border-top: 1px solid #000; margin-top: 3rem; text-align: center; padding-top: 0.5rem; 
        }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 24px; height: 24px; animation: spin 2s linear infinite; }
        .blinking-border { animation: blink 1s 3; }
        .tab-button { color: var(--tab-inactive-color); }
        .tab-button.active { border-color: var(--tab-active-color); color: var(--tab-active-color); background-color: var(--tab-active-bg); }
        input, select, textarea { 
            background-color: var(--input-bg-color); 
            border-color: var(--border-color);
            color: var(--text-color);
        }
        input::placeholder, textarea::placeholder { color: var(--input-placeholder-color); }
        
        /* Estilos para o Checklist e Barra de Progresso */
        .checklist-item { transition: all 0.3s ease; }
        .checklist-item.completed { color: #16a34a; }
        .checklist-item.completed .status-icon { background-color: #16a34a; color: white; }
        .status-icon {
            width: 24px; height: 24px; border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            font-weight: bold; border: 2px solid;
        }
        .progress-bar-container {
            width: 100%;
            background-color: var(--progress-bg);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .progress-bar {
            height: 1.25rem;
            background-color: var(--progress-fill);
            width: 0%;
            transition: width 0.4s ease;
            text-align: center;
            line-height: 1.25rem;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
        }

        @keyframes blink { 50% { border-color: #ef4444; box-shadow: 0 0 10px #ef4444; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl font-bold header-text">Gerador Automatizado de Ordem de Serviço</h1>
            <p class="text-lg mt-2 header-text">Um assistente inteligente para as suas necessidades de SST.</p>
            <button id="theme-toggle" class="absolute top-0 right-0 p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                <!-- Ícone de Sol (Modo Claro) -->
                <svg id="theme-toggle-sun" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <!-- Ícone de Lua (Modo Escuro) -->
                <svg id="theme-toggle-moon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <!-- Área de Notificação -->
        <div id="notification-area" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert">
            <span class="font-medium" id="notification-title"></span> <span id="notification-message"></span>
        </div>

        <div class="card p-6 sm:p-8">
            <!-- Navegação por Abas -->
            <div class="border-b" style="border-color: var(--border-color);">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button id="tab-btn-1" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">1. Dados Iniciais</button>
                    <button id="tab-btn-2" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg hover:border-gray-300">2. Análise de Riscos</button>
                    <button id="tab-btn-3" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg hover:border-gray-300">3. Finalizar e Relatório</button>
                </nav>
            </div>

            <!-- Conteúdo das Abas -->
            <div class="pt-8">
                <!-- Aba 1: Dados Iniciais -->
                <div id="tab-content-1" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <!-- Coluna do Checklist -->
                        <div class="md:col-span-1 border-r pr-8" style="border-color: var(--border-color);">
                            <h3 class="text-xl font-semibold mb-4">Checklist de Etapas</h3>
                            <ul class="space-y-4">
                                <li id="checklist-xlsx" class="checklist-item flex items-center gap-3">
                                    <span class="status-icon">1</span>
                                    <span>Carregar planilha de funcionários</span>
                                </li>
                                <li id="checklist-doc" class="checklist-item flex items-center gap-3">
                                    <span class="status-icon">2</span>
                                    <span>Carregar documento de SST</span>
                                </li>
                                <li id="checklist-employee" class="checklist-item flex items-center gap-3">
                                    <span class="status-icon">3</span>
                                    <span>Selecionar funcionário</span>
                                </li>
                            </ul>
                        </div>

                        <!-- Coluna de Conteúdo Principal -->
                        <div class="md:col-span-2 space-y-8">
                            <div>
                                <h3 class="text-xl font-semibold mb-4">1. Carregar Arquivos</h3>
                                <div class="grid grid-cols-1 gap-8">
                                    <div>
                                        <label for="xlsx-input" class="block mb-2 font-medium">1.1 - Planilha de Funcionários (.xlsx):</label>
                                        <input type="file" id="xlsx-input" accept=".xlsx" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-blue-50 dark:file:bg-blue-900 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 cursor-pointer">
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Colunas: 'Nome do Funcionário', 'Data de Admissão'. Opcional: 'Setor', 'Função', 'Descrição das Atividades', 'EPIs'.</p>
                                    </div>
                                    <div>
                                        <label for="sst-doc-input" class="block mb-2 font-medium">1.2 - Documento de SST (PGR, etc.):</label>
                                        <input type="file" id="sst-doc-input" accept="image/*,application/pdf" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-blue-50 dark:file:bg-blue-900 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 cursor-pointer">
                                        <div id="ocr-status" class="mt-2 text-sm"></div>
                                        <div id="progress-container" class="hidden mt-2">
                                            <div class="progress-bar-container">
                                                <div id="progress-bar" class="progress-bar">0%</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="logo-input" class="block mb-2 font-medium">1.3 - Logotipo da Empresa (Opcional):</label>
                                        <input type="file" id="logo-input" accept="image/*" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-blue-50 dark:file:bg-blue-900 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 dark:hover:file:bg-blue-800 cursor-pointer">
                                    </div>
                                </div>
                            </div>

                            <div class="border-t pt-6" style="border-color: var(--border-color);">
                                <h3 class="text-xl font-semibold mb-4">2. Selecionar Funcionário</h3>
                                <label for="employee-select" class="block mb-2 font-medium">Funcionário:</label>
                                <select id="employee-select" disabled class="w-full p-2 border rounded-lg bg-gray-200 dark:bg-gray-700 cursor-not-allowed transition-all duration-300">
                                    <option>Aguardando planilha...</option>
                                </select>
                            </div>

                            <div id="validation-section" class="hidden border-t pt-6" style="border-color: var(--border-color);">
                                <h3 class="text-xl font-semibold mb-4">3. Validar Dados Extraídos</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">O sistema extraiu as informações abaixo. Revise, corrija ou complete conforme necessário.</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="manual-setor" class="block text-sm font-medium">Setor:</label>
                                        <input type="text" id="manual-setor" class="w-full p-2 border rounded-lg transition-all duration-300">
                                    </div>
                                    <div>
                                        <label for="manual-funcao" class="block text-sm font-medium">Função:</label>
                                        <input type="text" id="manual-funcao" class="w-full p-2 border rounded-lg transition-all duration-300">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="manual-atividades" class="block text-sm font-medium">Descrição das Atividades:</label>
                                        <textarea id="manual-atividades" rows="3" class="w-full p-2 border rounded-lg" placeholder="Nenhuma descrição de atividades encontrada..."></textarea>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="manual-epi" class="block text-sm font-medium">EPIs (Equipamentos de Proteção Individual):</label>
                                        <textarea id="manual-epi" rows="3" class="w-full p-2 border rounded-lg" placeholder="Nenhuma informação de EPI encontrada..."></textarea>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="manual-medicoes" class="block text-sm font-medium">Medições Ambientais:</label>
                                        <textarea id="manual-medicoes" rows="3" class="w-full p-2 border rounded-lg" placeholder="Nenhuma medição encontrada..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba 2: Análise de Riscos -->
                <div id="tab-content-2" class="tab-content hidden">
                       <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="risk-cards-container">
                         <!-- Risk Cards will be generated by JS -->
                    </div>
                </div>

                <!-- Aba 3: Finalizar e Relatório -->
                <div id="tab-content-3" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <div class="text-center mb-8">
                               <h3 class="text-xl font-semibold mb-4">Gerar Ordem de Serviço</h3>
                                <button id="generate-pdf-btn" disabled class="btn bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Gerar PDF da Ordem de Serviço
                                </button>
                            </div>
                            <div class="border-t pt-8" style="border-color: var(--border-color);">
                                <h3 class="text-xl font-semibold mb-4">Relatório de OS Geradas (nesta sessão)</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full border" style="border-color: var(--border-color);">
                                        <thead style="background-color: var(--accordion-header-bg);">
                                            <tr>
                                                <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-color);">Nome do Funcionário</th>
                                                <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-color);">Setor</th>
                                                <th class="py-2 px-4 border-b text-left" style="border-color: var(--border-color);">Função</th>
                                            </tr>
                                        </thead>
                                        <tbody id="report-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div>
                             <h3 class="text-xl font-semibold mb-4 text-center">Pré-visualização da OS</h3>
                             <div id="live-os-preview-container" class="max-h-[80vh] overflow-y-auto">
                                <div id="live-os-preview">
                                    <p class="text-center text-gray-500">A pré-visualização aparecerá aqui assim que um funcionário for selecionado.</p>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de Pré-visualização para PDF (oculta) -->
        <div id="os-container" class="hidden"><div id="os-preview"></div></div>
    </div>

    <script>
        // --- BANCO DE DADOS DE RISCOS E DANOS ---
        const riskData = {
            fisico: {
                "Ruído": ["Perda Auditiva Induzida pelo Ruído Ocupacional (PAIRO)."], "Calor": [], "Frio": [],
                "Pressões anormais": ["Embolia gasosa", "Danos pulmonares", "Doença descompressiva"],
                "Radiações ionizantes": ["Dano às células do corpo humano, causando doenças graves, inclusive fatais, como câncer."],
                "Radiações não-ionizantes": ["Depressão imunológica", "fotoenvelhecimento", "lesões oculares como ceratoconjuntivite", "pterígio e catarata", "Doenças graves, inclusive fatais, como câncer."],
                "Umidade": ["Doenças de pele", "Micoses", "Doenças respiratórias"],
                "Vibrações localizadas (mão/braço)": ["Alterações articulares e vasomotoras."],
                "Vibração de corpo inteiro (AREN)": ["Alterações no sistema digestivo", "sistema musculoesquelético", "sistema nervoso", "alterações na visão", "enjoos", "náuseas", "palidez."],
                "Vibração de corpo inteiro (VDVR)": ["Alterações no sistema digestivo", "sistema musculoesquelético", "sistema nervoso", "alterações na visão", "enjoos", "náuseas", "palidez."],
                "Ambiente Artificialmente Frio": ["Estresse", "desconforto", "dormência", "rigidez nas partes com maior intensidade de exposição ao frio", "redução da destreza", "formigamento", "redução da sensibilidade dos dedos e flexibilidade das articulações."],
                "Trabalhos com perfuratrizes e marteletes pneumáticos": ["PAIR", "Problemas articulares e de coluna"],
            },
            quimico: {
                "Arsênio e seus compostos": ["Intoxicação", "Câncer de pele e pulmão"], "Asbestos (ou amianto)": ["Asbestose", "Mesotelioma", "Câncer de pulmão"],
                "Benzeno e seus compostos tóxicos": ["Leucemia", "Anemia", "Danos ao sistema nervoso"], "Berílio e seus compostos tóxicos": ["Beriliose", "Doença pulmonar crônica"],
                "Bromo e seus compostos tóxicos": [], "Cádmio e seus compostos tóxicos": ["Danos renais", "Enfisema pulmonar"], "Carvão mineral e seus derivados": [],
                "Chumbo e seus compostos tóxicos": ["Saturnismo", "Danos neurológicos e renais"], "Cloro e seus compostos tóxicos": [], "Cromo e seus compostos tóxicos": [],
                "Fósforo e seus compostos tóxicos": [], "Hidrocarbonetos e outros compostos de carbono": [], "Iodo": [], "Manganês e seus compostos": [],
                "Mercúrio e seus compostos": ["Hidrargirismo", "Danos neurológicos e renais"], "Níquel e seus compostos tóxicos": ["Dermatite de contato", "Câncer de pulmão e nasal"],
                "Petróleo, xisto betuminoso, gás natural e seus derivados": [], "Sílica livre": ["Silicose", "Doença pulmonar obstrutiva crônica (DPOC)"],
                "Outras substâncias químicas": ["Irritação/lesão ocular, na pele e mucosas", "Dermatites", "Queimadura Química", "Intoxicação", "Náuseas", "Vômitos."]
            },
            biologico: {
                "Trabalhos em estabelecimentos de saúde com contato com pacientes portadores de doenças infectocontagiosas ou com manuseio de materiais contaminados": ["Hepatites", "Tuberculose", "HIV", "COVID-19"],
                "Trabalhos com animais infectados para tratamento ou para o preparo de soro, vacinas e outros produtos": ["Brucelose", "Toxoplasmose", "Raiva"],
                "Trabalhos em laboratórios de autópsia, de anatomia e anátomo-histologia": ["Infecções diversas", "Contaminação por material biológico"],
                "Trabalho de exumação de corpos e manipulação de resíduos de animais deteriorados": ["Infecções", "Contaminação"],
                "Trabalhos em galerias, fossas e tanques de esgoto": ["Leptospirose", "Hepatite A", "Infecções gastrointestinais"], "Esvaziamento de biodigestores": [],
                "Coleta e industrialização do lixo": ["Tétano", "Hepatites", "Infecções de pele"]
            },
            acidente: {
                "Abrasão e/ou escoriação": ["Lesão na pele ou mucosa."], "Agentes cortantes e/ou perfurantes": ["Corte, ferimento, perfuração."],
                "Atropelamento": ["Prensamento ou aprisionamento de partes do corpo", "cortes", "escoriações", "luxações", "fraturas", "amputações."],
                "Batida contra": ["Escoriações", "luxações", "fraturas", "traumatismo craniano."],
                "Contato com animais peçonhentos": ["Reações alérgicas", "choque anafilático", "queimaduras", "intoxicação."],
                "Eletricidade": ["Queimadura de 1º, 2º ou 3º grau", "choque elétrico", "fibrilação ventricular", "parada cardiorrespiratória."],
                "Explosão": ["Queimadura de 1º, 2º ou 3º grau", "projeção de estilhaços", "cortes", "escoriações", "luxações", "fraturas", "amputações."],
                "Incêndio": ["Queimadura de 1º, 2º ou 3º grau", "asfixia", "intoxicação por gases."], "Projeção de partículas": ["Lesão ocular", "corte", "ferimento", "perfuração."],
                "Queda de mesmo nível": ["Escoriações", "luxações", "fraturas", "traumatismo craniano."], "Queda de nível diferente": ["Escoriações", "luxações", "fraturas", "traumatismo craniano", "lesão medular."],
                "Queda de objetos": ["Prensamento ou aprisionamento de partes do corpo", "cortes", "escoriações", "luxações", "fraturas", "amputações."],
                "Soterramento": ["Asfixia", "desconforto respiratório", "nível de consciência alterado", "letargia", "palidez", "pele azulada", "tosse", "transtorno neurológico."],
                "Trabalho em espaços confinados": ["Asfixia", "hiperóxia", "contaminação por poeiras e/ou gases tóxicos", "queimadura", "afogamento."]
            },
            ergonomico: {
                "Levantamento e transporte manual de peso": ["Dores lombares", "Hérnia de disco", "Lesões musculoesqueléticas"],
                "Postura inadequada (sentado, em pé, agachado)": ["Dores na coluna", "Fadiga muscular", "LER/DORT"],
                "Movimentos repetitivos": ["Tendinite", "Tenossinovite", "Síndrome do túnel do carpo", "LER/DORT"],
                "Jornada de trabalho prolongada": ["Estresse", "Fadiga crônica", "Burnout"],
                "Ritmo excessivo de trabalho": ["Estresse", "Ansiedade", "Fadiga mental"],
                "Monotonia das tarefas": ["Desmotivação", "Estresse", "Problemas de saúde mental"],
                "Exigência de força excessiva": ["Distensões musculares", "Rupturas de tendões", "Lesões articulares"]
            }
        };

        // --- LÓGICA DA APLICAÇÃO ---
        let employeeData = [];
        let generatedOSReport = [];
        let logoDataUrl = null;
        const defaultText = "Não identificado no momento da avaliação.";
        const checklistStatus = {
            xlsx: false,
            doc: false,
            employee: false
        };

        // DOM Elements
        const notificationArea = document.getElementById('notification-area');
        const notificationTitle = document.getElementById('notification-title');
        const notificationMessage = document.getElementById('notification-message');
        const xlsxInput = document.getElementById('xlsx-input');
        const employeeSelect = document.getElementById('employee-select');
        const sstDocInput = document.getElementById('sst-doc-input');
        const logoInput = document.getElementById('logo-input');
        const ocrStatus = document.getElementById('ocr-status');
        const validationSection = document.getElementById('validation-section');
        const manualSetor = document.getElementById('manual-setor');
        const manualFuncao = document.getElementById('manual-funcao');
        const manualAtividades = document.getElementById('manual-atividades');
        const manualEpi = document.getElementById('manual-epi');
        const manualMedicoes = document.getElementById('manual-medicoes');
        const generatePdfBtn = document.getElementById('generate-pdf-btn');
        const reportTableBody = document.getElementById('report-table-body');
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('theme-toggle-sun');
        const moonIcon = document.getElementById('theme-toggle-moon');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const liveOsPreview = document.getElementById('live-os-preview');

        // --- FUNÇÕES AUXILIARES ---

        function formatAsTitle(inputText) {
            if (!inputText || typeof inputText !== 'string') return '';
            let txt = inputText.toLowerCase().split(" ");
            let excecoes = ["da", "de", "do", "dos", "das", "em", "para", "com", "no", "na", "nos", "nas"];
            for (let i = 0; i < txt.length; i++) {
                if (!excecoes.includes(txt[i]) || i === 0) {
                    txt[i] = txt[i].charAt(0).toUpperCase() + txt[i].slice(1);
                }
            }
            return txt.join(" ");
        }

        function showNotification(type, title, message) {
            notificationArea.className = 'p-4 mb-4 text-sm rounded-lg';
            let typeClasses = type === 'error' ? 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300' : (type === 'warning' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300' : 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300');
            notificationArea.classList.add(...typeClasses.split(' '));
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
        }

        function hideNotification() { notificationArea.classList.add('hidden'); }
        
        // --- LÓGICA DO CHECKLIST ---
        function updateChecklist(item, isComplete) {
            checklistStatus[item] = isComplete;
            const element = document.getElementById(`checklist-${item}`);
            const icon = element.querySelector('.status-icon');
            if (isComplete) {
                element.classList.add('completed');
                icon.innerHTML = '&#10003;'; // Checkmark
            } else {
                element.classList.remove('completed');
                const number = item === 'xlsx' ? '1' : (item === 'doc' ? '2' : '3');
                icon.innerHTML = number;
            }
            checkFormReadiness();
        }

        // --- LÓGICA DE CRIAÇÃO DA UI ---

        function createRiskCards() {
            const container = document.getElementById('risk-cards-container');
            container.innerHTML = '';
            const riskCategories = {
                fisico: { title: 'Risco Físico', colorVar: '--risk-fisico-color' },
                quimico: { title: 'Risco Químico', colorVar: '--risk-quimico-color' },
                biologico: { title: 'Risco Biológico', colorVar: '--risk-biologico-color' },
                acidente: { title: 'Risco de Acidente', colorVar: '--risk-acidente-color' },
                ergonomico: { title: 'Risco Ergonômico', colorVar: '--risk-ergonomico-color' }
            };

            const displayOrder = ['acidente', 'ergonomico', 'quimico', 'fisico', 'biologico'];

            for (const key of displayOrder) {
                const category = riskCategories[key];
                const card = document.createElement('div');
                card.className = 'border-2 rounded-lg p-4 space-y-3 transition-all';
                card.style.borderColor = `var(${category.colorVar})`;
                
                card.innerHTML = `
                    <h4 class="text-lg font-semibold" style="color: var(${category.colorVar});">${category.title}</h4>
                    <div>
                        <label class="block text-sm font-medium mb-1">Perigos / Fatores de Risco:</label>
                        <div id="risk-${key}-checkboxes" class="risk-checkbox-container"></div>
                        <textarea id="risk-${key}-outro" rows="1" class="w-full p-2 border rounded-lg mt-2" placeholder="Outro..."></textarea>
                    </div>
                    <div>
                        <label for="damage-${key}" class="block text-sm font-medium mb-1">Possíveis Danos à Saúde:</label>
                        <textarea id="damage-${key}" rows="3" class="w-full p-2 border rounded-lg" placeholder="Danos serão preenchidos automaticamente..."></textarea>
                    </div>
                `;
                container.appendChild(card);
                // Adiciona listener para atualização da preview ao vivo
                container.querySelectorAll('input, textarea').forEach(el => el.addEventListener('input', updateLivePreview));
            }
            populateRiskCheckboxes();
        }

        function populateRiskCheckboxes() {
            for (const category in riskData) {
                const container = document.getElementById(`risk-${category}-checkboxes`);
                if (container) {
                    const sortedRisks = Object.keys(riskData[category]).sort();
                    for (const risk of sortedRisks) {
                        const label = document.createElement('label');
                        label.className = 'flex items-center space-x-2 cursor-pointer p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded';
                        const input = document.createElement('input');
                        input.type = 'checkbox'; input.value = risk; input.dataset.category = category;
                        input.className = 'rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-200 dark:bg-gray-700 dark:border-gray-600';
                        const span = document.createElement('span'); span.textContent = risk;
                        label.appendChild(input); label.appendChild(span); container.appendChild(label);
                        input.addEventListener('change', () => {
                            handleRiskSelectionChange();
                            updateLivePreview();
                        });
                    }
                }
            }
        }
        
        // --- LÓGICA DE EVENTOS E MANIPULAÇÃO DE DADOS ---

        function handleRiskSelectionChange() {
            const categories = ['fisico', 'quimico', 'biologico', 'acidente', 'ergonomico'];
            categories.forEach(category => {
                const damageTextarea = document.getElementById(`damage-${category}`);
                const allDamages = new Set();
                document.querySelectorAll(`#risk-${category}-checkboxes input:checked`).forEach(checkbox => {
                    const risk = checkbox.value;
                    const damages = riskData[category][risk] || [];
                    damages.forEach(damage => allDamages.add(damage));
                });
                damageTextarea.value = Array.from(allDamages).join(', ');
            });
        }

        xlsxInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                updateChecklist('xlsx', false);
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    employeeData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    populateEmployeeSelect();
                    updateChecklist('xlsx', true);
                } catch (error) {
                    showNotification('error', 'Erro de Arquivo!', 'Não foi possível ler a planilha. Verifique o formato (.xlsx) e as colunas.');
                    updateChecklist('xlsx', false);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function populateEmployeeSelect() {
            employeeSelect.innerHTML = '<option>Aguardando planilha...</option>';
            employeeSelect.innerHTML = '<option value="">-- Selecione um funcionário --</option>';
            employeeData.forEach((employee, index) => {
                const employeeName = findValueInObject(employee, ['Nome do Funcionário', 'Nome']);
                if (employeeName) {
                    const option = document.createElement('option');
                    option.value = index; option.textContent = formatAsTitle(employeeName);
                    employeeSelect.appendChild(option);
                }
            });
            employeeSelect.disabled = false;
            employeeSelect.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'cursor-not-allowed');
        }

        sstDocInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                updateChecklist('doc', false);
                return;
            }
            ocrStatus.textContent = 'Iniciando análise do documento...';
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            validationSection.classList.add('hidden');
            hideNotification();

            try {
                const worker = await Tesseract.createWorker('por', 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 100);
                            progressBar.style.width = `${progress}%`;
                            progressBar.textContent = `${progress}%`;
                        }
                    },
                });
                const { data: { text } } = await worker.recognize(file);
                await worker.terminate();

                parseOCRText(text);
                updateDetailsFromSources();
                updateChecklist('doc', true);
            } catch (error) {
                ocrStatus.textContent = '';
                progressContainer.classList.add('hidden');
                showNotification('error', 'Erro de OCR!', 'Ocorreu uma falha ao ler o documento. Tentando carregar dados da planilha...');
                validationSection.classList.remove('hidden');
                updateDetailsFromSources();
                updateChecklist('doc', true);
            }
        });
        
        logoInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                logoDataUrl = null;
                updateLivePreview();
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                logoDataUrl = e.target.result;
                updateLivePreview();
            };
            reader.readAsDataURL(file);
        });


        employeeSelect.addEventListener('change', () => {
            updateDetailsFromSources();
            updateChecklist('employee', employeeSelect.value !== "");
            updateLivePreview();
        });
        
        function parseOCRText(text) {
            const sections = {};
            const keywords = {
                setor: /\b(setor|área|departamento)\s*:\s*/i,
                funcao: /\b(função|cargo)\s*:\s*/i,
                atividades: /\b(atividades|descrição\s+d[ao](s)?\s+(função|atividades)|tarefas)\s*:\s*/i,
                epi: /\b(EPIs?|equipamentos\s+de\s+proteção\s+individual)\s*:\s*/i,
                medicoes: /\b(medições|avaliações\s+ambientais|resultados\s+das\s+avaliações)\s*:\s*/i
            };

            const foundMatches = [];
            for (const key in keywords) {
                const match = text.match(keywords[key]);
                if (match) {
                    foundMatches.push({ key: key, index: match.index, length: match[0].length });
                }
            }

            foundMatches.sort((a, b) => a.index - b.index);

            for (let i = 0; i < foundMatches.length; i++) {
                const currentMatch = foundMatches[i];
                const nextMatch = foundMatches[i + 1];

                const startIndex = currentMatch.index + currentMatch.length;
                const endIndex = nextMatch ? nextMatch.index : text.length;

                let content = text.substring(startIndex, endIndex);
                sections[currentMatch.key] = content.replace(/(\r\n|\n|\r)/gm, " ").replace(/\s+/g, ' ').trim();
            }

            ocrStatus.textContent = `✅ Documento processado. Validando com dados da planilha...`;
            progressContainer.classList.add('hidden');
            manualSetor.value = formatAsTitle(sections.setor || '');
            manualFuncao.value = formatAsTitle(sections.funcao || '');
            manualAtividades.value = sections.atividades || '';
            manualEpi.value = sections.epi || '';
            manualMedicoes.value = sections.medicoes || '';
        }

        function findValueInObject(obj, keys) {
            if (!obj) return null;
            const objKeys = Object.keys(obj);
            for (const key of keys) {
                const foundKey = objKeys.find(objKey => objKey.toLowerCase() === key.toLowerCase());
                if (foundKey) {
                    return obj[foundKey];
                }
            }
            return null;
        }

        function updateDetailsFromSources() {
            const selectedIndex = employeeSelect.value;
            if (selectedIndex === "" || !employeeData[selectedIndex]) {
                return;
            }
            const employee = employeeData[selectedIndex];
            validationSection.classList.remove('hidden');

            const fieldMapping = {
                'manual-setor': ['Setor', 'Área', 'Departamento'],
                'manual-funcao': ['Função', 'Cargo'],
                'manual-atividades': ['Atividades', 'Descrição da Função', 'Descrição das Atividades', 'Tarefas'],
                'manual-epi': ['EPIs', 'EPIs Recomendados', 'Equipamentos de Proteção Individual', 'EPI']
            };

            for (const inputId in fieldMapping) {
                const inputElement = document.getElementById(inputId);
                if (inputElement.value.trim() === '') {
                    const valueFromSheet = findValueInObject(employee, fieldMapping[inputId]);
                    if (valueFromSheet) {
                        inputElement.value = valueFromSheet;
                    }
                }
            }
            checkFormReadiness();
        }

        function checkFormReadiness() {
            const allChecked = Object.values(checklistStatus).every(status => status);
            generatePdfBtn.disabled = !allChecked;
        }

        [manualSetor, manualFuncao, manualAtividades, manualEpi, manualMedicoes].forEach(el => el.addEventListener('input', updateLivePreview));

        function validateForm() {
            let isValid = true;
            const fieldsToValidate = [
                { el: employeeSelect, msg: 'Selecione um funcionário.' },
                { el: manualSetor, msg: 'Preencha o campo Setor.' },
                { el: manualFuncao, msg: 'Preencha o campo Função.' }
            ];
            fieldsToValidate.forEach(field => field.el.classList.remove('blinking-border'));
            hideNotification();
            let missingFieldsMessages = [];
            fieldsToValidate.forEach(field => {
                if (!field.el.value.trim()) {
                    isValid = false;
                    field.el.classList.add('blinking-border');
                    missingFieldsMessages.push(field.msg);
                }
            });
            if (!isValid) {
                showNotification('warning', 'Campos Obrigatórios!', missingFieldsMessages.join(' '));
            }
            return isValid;
        }

        generatePdfBtn.addEventListener('click', () => {
            if (!validateForm()) return;
            const previewContent = document.getElementById('live-os-preview').innerHTML;
            document.getElementById('os-preview').innerHTML = previewContent;
            
            const employee = employeeData[employeeSelect.value];
            const employeeName = findValueInObject(employee, ['Nome do Funcionário', 'Nome']);
            const fileName = `OS - ${employeeName}.pdf`;
            const options = { margin: 0.5, filename: fileName, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
            
            html2pdf().from(document.getElementById('os-preview')).set(options).save().then(() => {
                addToReport({ 
                    nome: formatAsTitle(employeeName), 
                    setor: formatAsTitle(manualSetor.value), 
                    funcao: formatAsTitle(manualFuncao.value) 
                });
            });
        });
        
        function getCombinedRisks(category) {
            const selectedRisks = Array.from(document.querySelectorAll(`#risk-${category}-checkboxes input:checked`)).map(cb => cb.value);
            const otherRisk = document.getElementById(`risk-${category}-outro`).value.trim();
            if (otherRisk) selectedRisks.push(otherRisk);
            return selectedRisks.join(', ') || defaultText;
        }

        function updateLivePreview() {
            if (employeeSelect.value === "") {
                liveOsPreview.innerHTML = `<p class="text-center text-gray-500">A pré-visualização aparecerá aqui assim que um funcionário for selecionado.</p>`;
                return;
            }
            
            const employee = employeeData[employeeSelect.value];
            const setor = manualSetor.value.trim();
            const funcao = manualFuncao.value.trim();

            const atividadesText = manualAtividades.value.trim() || defaultText;
            const epiText = manualEpi.value.trim() || defaultText;
            const medicoesText = manualMedicoes.value.trim() || defaultText;
            
            const employeeName = findValueInObject(employee, ['Nome do Funcionário', 'Nome']) || 'N/A';
            const admissionDate = findValueInObject(employee, ['Data de Admissão']) || 'N/A';
            const formattedEmployeeName = formatAsTitle(employeeName);
            const formattedSetor = formatAsTitle(setor);
            const formattedFuncao = formatAsTitle(funcao);
            
            const logoHtml = logoDataUrl ? `<img src="${logoDataUrl}" alt="Logotipo" style="max-width: 150px; max-height: 80px; object-fit: contain;">` : '';

            liveOsPreview.innerHTML = `
                <h2>ORDEM DE SERVIÇO - SEGURANÇA E SAÚDE NO TRABALHO (NR-01)</h2>
                <table class="header-table">
                    <tr>
                        <td rowspan="3" style="width: 160px; text-align: center; vertical-align: middle; border-right: 1px solid #000;">
                            ${logoHtml}
                        </td>
                        <td colspan="2"><strong>Empresa:</strong> [Nome da Empresa]</td>
                        <td colspan="2"><strong>Unidade:</strong> [Unidade a ser definida]</td>
                    </tr>
                    <tr>
                        <td colspan="2"><strong>Nome do Funcionário:</strong> ${formattedEmployeeName}</td>
                        <td colspan="2"><strong>Data de Admissão:</strong> ${admissionDate}</td>
                    </tr>
                    <tr>
                        <td colspan="2"><strong>Setor de Trabalho:</strong> ${formattedSetor}</td>
                        <td colspan="2"><strong>Função:</strong> ${formattedFuncao}</td>
                    </tr>
                </table>
                <h3>DESCRIÇÃO DAS ATIVIDADES (TAREFAS DA FUNÇÃO)</h3>
                <p>${atividadesText}</p>
                <h3>AGENTES DE RISCOS OCUPACIONAIS</h3>
                <table>
                    <tr><td><strong>Acidente:</strong> ${getCombinedRisks('acidente')}</td><td><strong>Físico:</strong> ${getCombinedRisks('fisico')}</td></tr>
                    <tr><td><strong>Ergonômico:</strong> ${getCombinedRisks('ergonomico')}</td><td><strong>Químico:</strong> ${getCombinedRisks('quimico')}</td></tr>
                    <tr><td colspan="2"><strong>Biológico:</strong> ${getCombinedRisks('biologico')}</td></tr>
                </table>
                <h3>POSSÍVEIS DANOS À SAÚDE</h3>
                <table>
                    <tr><td><strong>Acidente:</strong> ${document.getElementById('damage-acidente').value.trim() || defaultText}</td><td><strong>Físico:</strong> ${document.getElementById('damage-fisico').value.trim() || defaultText}</td></tr>
                    <tr><td><strong>Ergonômico:</strong> ${document.getElementById('damage-ergonomico').value.trim() || defaultText}</td><td><strong>Químico:</strong> ${document.getElementById('damage-quimico').value.trim() || defaultText}</td></tr>
                    <tr><td colspan="2"><strong>Biológico:</strong> ${document.getElementById('damage-biologico').value.trim() || defaultText}</td></tr>
                </table>
                <h3>MEDIDAS ADOTADAS PELA EMPRESA</h3>
                <p><strong>EPI:</strong> ${epiText}</p>
                <p>"Treinamento e Supervisão para execução das tarefas e uso dos EPI..."</p>
                <h3>INFORME DOS RESULTADOS DAS AVALIAÇÕES AMBIENTAIS</h3>
                <p>${medicoesText}</p>
                <p style="margin-top: 1rem;">Conforme Art. 158 da CLT e NR-01 item 1.4.2.1...</p>
                <table style="margin-top: 2rem; width: 100%; text-align: center; border: none;"><tr style="border: none;"><td style="border: none;">___________________________<br>SESMT</td><td style="border: none;">___________________________<br>Chefia Imediata</td></tr></table>
                <p style="margin-top: 1rem;">Cópia recebida em: ______/______/______</p>
                <div class="signature-line" style="margin-top: 3rem;">${formattedEmployeeName}</div>
            `;
        }
        
        function addToReport(data) { generatedOSReport.push(data); updateReportTable(); }
        function updateReportTable() {
            reportTableBody.innerHTML = '';
            generatedOSReport.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="py-2 px-4 border-b" style="border-color: var(--border-color);">${item.nome}</td><td class="py-2 px-4 border-b" style="border-color: var(--border-color);">${item.setor}</td><td class="py-2 px-4 border-b" style="border-color: var(--border-color);">${item.funcao}</td>`;
                reportTableBody.appendChild(row);
            });
        }
        
        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            createRiskCards();
            
            // Lógica das Abas
            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const target = tab.id.replace('btn', 'content');
                    tabContents.forEach(c => c.classList.add('hidden'));
                    document.getElementById(target).classList.remove('hidden');
                });
            });

            // Lógica do Modo Noturno
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }

            themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                sunIcon.classList.toggle('hidden');
                moonIcon.classList.toggle('hidden');
                if (document.documentElement.classList.contains('dark')) {
                    localStorage.setItem('theme', 'dark');
                } else {
                    localStorage.setItem('theme', 'light');
                }
            });
        });
    </script>
</body>
</html>
